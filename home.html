<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DMS Â· Gemello Digitale del Commercio â€” Home</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bgA:#0e2d38; --bgB:#155268;
    --ink:#dde2e4; --accent:#46a0bd;
    --panel:#0b2128; --glass:rgba(255,255,255,.08);
    --btnW:clamp(92px, 11vmin, 150px);
    --r:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background: radial-gradient(1200px 800px at 60% 20%, #1a566b 0%, transparent 60%),
                linear-gradient(180deg, var(--bgB), var(--bgA));
    font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overflow:hidden;
  }

  /* Testata */
  .brand{
    position:fixed; right:24px; top:28px; text-align:right; z-index:5;
    letter-spacing:.02em; line-height:1.1; margin:0;
  }
  .brand b{display:block; font-size:28px}
  .brand small{opacity:.85; display:block; margin-top:6px}

  /* Toolbar */
  .toolbar{position:fixed; left:20px; top:20px; display:flex; gap:10px; z-index:5}
  .btn{
    appearance:none; border:2px solid rgba(255,255,255,.2);
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    color:var(--ink); padding:.55rem .9rem; border-radius:12px; font-weight:700;
    backdrop-filter:blur(6px); text-decoration:none; cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.25) }
  .btn:focus-visible{ outline:2px solid var(--accent); outline-offset:2px }

  /* Ellisse con tacche + lancetta */
  #ellipseLayer{position:fixed; inset:0; z-index:2; pointer-events:none}
  .tick{ stroke:rgba(220,245,255,.6); stroke-width:2; stroke-linecap:round }
  .center-dot{ fill:rgba(255,255,255,.8) }
  #hand{ stroke:#fff; stroke-width:3; stroke-linecap:round }

  /* Vista centrale */
  #viewport{
    position:fixed; z-index:3; border-radius:20px; overflow:hidden;
    border:2px solid rgba(255,255,255,.25);
    background:rgba(0,0,0,.28); box-shadow:0 18px 40px rgba(0,0,0,.45);
  }
  #viewport video,#viewport iframe{width:100%; height:100%; display:block; border:0}

  /* 12 nodi */
  .node{
    position:fixed; width:var(--btnW); height:var(--btnW); z-index:4;
    border-radius:var(--r); border:2px solid rgba(190,230,240,.95);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    display:grid; place-items:center; color:var(--ink);
    box-shadow:0 10px 22px rgba(0,0,0,.28), inset 0 0 0 0 rgba(255,255,255,.15);
    backdrop-filter:blur(4px); transition:transform .15s ease, box-shadow .15s ease;
  }
  .node span{font-weight:700; opacity:.9}
  .node:hover{ transform:translateY(-2px); box-shadow:0 14px 28px rgba(0,0,0,.36) }
  .node:focus-visible{ outline:2px solid var(--accent); outline-offset:2px }

  /* Mini controlli nel viewport */
  .vp-actions{
    position:absolute; right:10px; bottom:10px; display:flex; gap:8px; z-index:10;
  }
  .vp-actions .chip{
    font-weight:700; padding:.45rem .6rem; border-radius:10px; cursor:pointer;
    border:1px solid rgba(255,255,255,.25); background:var(--glass);
  }

  @media (max-width:820px){
    .brand b{font-size:22px}
  }
</style>
</head>
<body>

  <p class="brand">
    <b>GEMELLO DIGITALE</b>
    <b>DEL COMMERCIO</b>
    <small>DMS â€¢ Orologio roadmap</small>
  </p>

  <div class="toolbar">
    <a class="btn" href="./index.html">ðŸŽ¬ Spot</a>
    <a class="btn" href="./mindmap.html">ðŸ§  Mappa</a>
  </div>

  <svg id="ellipseLayer" aria-hidden="true"></svg>
  <div id="viewport" role="region" aria-label="contenuto centrale"></div>

<script>
(() => {
  const S = {nodes:12, tries:10, retryMs:300};
  let viewport, svg, heroPlaying=false, mods=null;

  // --- Helpers --------------------------------------------------------------
  const $ = sel => document.querySelector(sel);
  const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);

  function makeNodes(){
    const frag = document.createDocumentFragment();
    for(let i=0;i<S.nodes;i++){
      const b = el('button',{className:'node','aria-label':`Apri PDF ${i+1}`});
      b.innerHTML = '<span>PDF</span>';
      b.dataset.i = i;
      frag.appendChild(b);
    }
    document.body.appendChild(frag);
  }

  async function loadModules(){
    if(mods) return mods;
    try{
      const r = await fetch('./data/modules.json?ts='+Date.now());
      if(!r.ok) throw new Error(r.status);
      mods = await r.json();
    }catch(e){
      console.warn('modules.json non disponibile:', e);
      mods = []; // fallback: nessun blocco
    }
    return mods;
  }

  function ensureHero(){
    if(!viewport) return;
    // se c'Ã¨ giÃ  un media, non raddoppiare
    if(viewport.querySelector('video,iframe')) return;
    viewport.innerHTML = '';
    const v = el('video',{
      muted:true, autoplay:true, loop:true, playsInline:true,
      src:'./videos/video-hero.mp4'
    });
    v.setAttribute('webkit-playsinline','');
    v.preload = 'metadata';

    // retry robusto per iOS
    const tryPlay = async (n=0) => {
      try{
        await v.play();
        heroPlaying=true;
      }catch{
        if(n < S.tries){
          setTimeout(()=>tryPlay(n+1), S.retryMs);
        }else{
          // fallback
          v.src = './videos/teaser-hub-dms.mp4';
          v.load(); setTimeout(()=>tryPlay(n+1), S.retryMs);
        }
      }
    };
    v.addEventListener('loadeddata', ()=>{ if(!heroPlaying) tryPlay(); });
    viewport.appendChild(v);
    tryPlay();
  }

  function viewportPanel(mod){
    const box = el('div');
    box.style = "position:relative;width:100%;height:100%";
    const iframe = el('iframe',{src:mod.pdf, title:mod.title||'Documento'});
    iframe.loading = 'lazy';
    box.appendChild(iframe);

    const actions = el('div',{className:'vp-actions'});
    const open = el('a',{className:'chip',textContent:'Apri in nuova scheda', target:'_blank', rel:'noopener', href:mod.pdf});
    const back = el('button',{className:'chip',textContent:'Torna al video'});
    back.onclick = () => { viewport.innerHTML=''; heroPlaying=false; ensureHero(); };
    actions.append(open, back);
    box.appendChild(actions);

    viewport.innerHTML=''; viewport.appendChild(box);
  }

  function bindNodes(){
    document.querySelectorAll('.node').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const i = +btn.dataset.i;
        const list = await loadModules();
        const mod = list[i];
        if(mod && mod.pdf){
          viewportPanel(mod);
        }else{
          viewport.innerHTML = '<div style="display:grid;place-items:center;height:100%;font-weight:800;color:#cfe8f0">Â· presto</div>';
        }
      });
    });
  }

  function layout(){
    viewport = $('#viewport'); svg = $('#ellipseLayer');
    const W=innerWidth, H=innerHeight, cx=W/2, cy=H*0.50;

    // dimensione nodi
    const btnW = Math.max(92, Math.min(Math.round(W*0.10), 150));
    document.documentElement.style.setProperty('--btnW', btnW+'px');

    // ellisse calcolata per non tagliare i nodi
    const margin=24;
    const a = Math.min(W/2 - margin - btnW/2, W*0.46);
    const b = Math.min(H/2 - margin - btnW/2, H*0.36);

    // viewport 16:9 dentro ellisse interna
    const innerA=a-btnW*0.60, innerB=b-btnW*0.60;
    let vw=W*0.62, vh=vw*9/16, maxH=H*0.44;
    if(vh>maxH){ vh=maxH; vw=vh*16/9; }
    let k=1;
    while(((((vw*k)/2)**2)/(innerA**2) + (((vh*k)/2)**2)/(innerB**2))>1 && k>0.4){ k-=0.02; }
    vw*=k; vh*=k;
    viewport.style.cssText = `width:${vw}px;height:${vh}px;left:${cx-vw/2}px;top:${cy-vh/2}px`;

    // ellisse con tacche
    svg.setAttribute('viewBox',`0 0 ${W} ${H}`); svg.innerHTML='';
    const g = document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(g);
    for(let i=0;i<12;i++){
      const t = -Math.PI/2 + 2*Math.PI*i/12;
      const ix=cx+(a-18)*Math.cos(t), iy=cy+(b-18)*Math.sin(t);
      const ex=cx+a*Math.cos(t),      ey=cy+b*Math.sin(t);
      const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
      ln.setAttribute('x1',ix); ln.setAttribute('y1',iy); ln.setAttribute('x2',ex); ln.setAttribute('y2',ey);
      ln.setAttribute('class','tick'); g.appendChild(ln);
    }
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',10); c.setAttribute('class','center-dot'); g.appendChild(c);
    const hand=document.createElementNS('http://www.w3.org/2000/svg','line');
    hand.id='hand'; hand.setAttribute('x1',cx); hand.setAttribute('y1',cy); hand.setAttribute('x2',cx); hand.setAttribute('y2',cy);
    hand.setAttribute('stroke','rgba(255,255,255,.9)'); hand.setAttribute('stroke-width','3'); hand.setAttribute('stroke-linecap','round');
    g.appendChild(hand);

    // âœ… NUOVO: puntale triangolare
    const handTip = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    handTip.id = 'handTip';
    handTip.setAttribute('fill','rgba(255,255,255,.95)');
    g.appendChild(handTip);

    // posiziona i 12 nodi
    document.querySelectorAll('.node').forEach((el,i)=>{
      const t = -Math.PI/2 + 2*Math.PI*i/12;
      el.style.left = (cx + a*Math.cos(t) - btnW/2)+'px';
      el.style.top  = (cy + b*Math.sin(t) - btnW/2)+'px';
    });

    // animazione lancetta (rispetta prefers-reduced-motion)
    const prefers = matchMedia('(prefers-reduced-motion: reduce)').matches;
    if(!prefers){
      let start=null;
      const anim = ts=>{
        if(!start) start=ts;
        const T=12000, th=-Math.PI/2 + 2*Math.PI*((ts-start)%T)/T;
        const px = cx + a*Math.cos(th)*0.95; // punta linea
        const py = cy + b*Math.sin(th)*0.95;
        hand.setAttribute('x2', px);
        hand.setAttribute('y2', py);
        
        // âœ… NUOVO: geometria del triangolo
        const baseX = cx + a * Math.cos(th) * 0.86; // base triangolo arretrata lungo la lancetta
        const baseY = cy + b * Math.sin(th) * 0.86;
        const nx = -Math.sin(th), ny = Math.cos(th); // normale per larghezza
        const half = 10; // metÃ  larghezza del puntale
        
        // punti: punta + vertice base dx + vertice base sx
        handTip.setAttribute(
          'points',
          `${px},${py} ${baseX + nx*half},${baseY + ny*half} ${baseX - nx*half},${baseY - ny*half}`
        );
        
        requestAnimationFrame(anim);
      };
      requestAnimationFrame(anim);
    }
  }

  // bootstrap
  document.addEventListener('DOMContentLoaded', ()=>{
    makeNodes(); layout(); ensureHero(); bindNodes();
  });
  addEventListener('resize', layout);
  addEventListener('pageshow', ensureHero);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ ensureHero(); }});
})();
</script>
</body>
</html>

