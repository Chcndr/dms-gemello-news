<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DMS Â· Gemello del Commercio â€” Home</title>

<style>
  :root{
    --bg-a:#071a1d; --bg-b:#0b2730;       /* tema verde scuro elegante */
    --ink:#e8fbff; --ink-2:#9bd6de;
    --accent:#14b8a6;
    --btnW-base:140;                      /* base in px, usata anche da JS */
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 60% 20%, rgba(255,255,255,.04), transparent 60%),
      linear-gradient(180deg, var(--bg-b), var(--bg-a));
    font: 16px/1.4 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    overflow:hidden;
  }

  /* Toolbar sinistra */
  .toolbar{
    position:fixed; left:20px; top:20px; z-index:5; display:flex; gap:8px;
  }
  .btn{
    appearance:none; border:none; cursor:pointer;
    padding:.55rem .9rem; border-radius:12px;
    color:var(--ink); background:rgba(20,80,100,.32);
    border:2px solid rgba(255,255,255,.20);
    backdrop-filter: blur(6px);
    font-weight:700; text-decoration:none;
  }

  /* Claim destra */
  .claim{
    position:fixed; right:24px; top:24px; z-index:5; text-align:right;
    margin:0; line-height:1.1; letter-spacing:.02em;
  }
  .claim b{display:block; font-size:28px}
  .claim small{display:block; opacity:.8; font-size:14px; margin-top:6px}

  /* Layering: spotlight(1) â†’ ellipse(2) â†’ viewport(3) â†’ nodes(4) */
  #glowLayer{ position:fixed; inset:0; z-index:1; pointer-events:none; }
  #ellipseLayer{ position:fixed; inset:0; z-index:2; pointer-events:none; }
  #viewport{ position:fixed; z-index:3; border-radius:20px; overflow:hidden;
    border:2px solid rgba(255,255,255,.22);
    background: rgba(0,0,0,.28);
    box-shadow: 0 18px 40px rgba(0,0,0,.45);
  }

  /* Pulsanti */
  .node{
    position:fixed;
    width:calc(var(--btnW, 140) * 1px); height:calc(var(--btnW, 140) * 1px);
    left:50%; top:50%;
    transform: translate(var(--x, -50%), var(--y, -50%)); /* posizionati da JS */
    border-radius:16px; z-index:4;
    border: 2px solid rgba(255,255,255,.55);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    color: var(--ink);
    display:grid; place-items:center;
    box-shadow: 0 12px 26px rgba(0,0,0,.30), inset 0 0 0 1px rgba(255,255,255,.12);
    backdrop-filter: blur(4px);
    transition: transform .15s ease;
    will-change: transform;
  }
  .node .tag{opacity:.95; font-weight:800; letter-spacing:.02em}

  /* Glow forte solo su hover (tutti neutri a riposo) */
  .node:hover{
    transform: translate(var(--x), var(--y)) translateY(-2px);
    box-shadow:
      0 18px 38px rgba(0,0,0,.36),
      0 0 0 6px rgba(20, 184, 166, .35),
      0 0 38px 28px rgba(20, 184, 166, .20),
      inset 0 0 0 2px rgba(255,255,255,.22);
    border-color: rgba(255,255,255,.85);
  }

  /* Spotlight che segue il mouse (sotto ai pulsanti) */
  #glowLayer{
    background:
      radial-gradient(300px 300px at var(--mx, -1000px) var(--my, -1000px),
        rgba(20,184,166,.32), transparent 70%);
  }

  /* Video e iframe dentro viewport */
  #viewport > video, #viewport > iframe{
    width:100%; height:100%; display:block; border:0;
    background:#000;
  }

  /* AccessibilitÃ  */
  @media (prefers-reduced-motion: reduce){
    .node{ transition:none }
  }
</style>

</head>
<body>

  <div class="toolbar">
    <a class="btn" href="./index.html">ðŸŽ¬ Spot</a>
    <a class="btn" href="./mindmap.html">ðŸ§  Mappa</a>
  </div>

  <h1 class="claim">
    <b>GEMELLO DIGITALE</b>
    <b>DEL COMMERCIO</b>
    <small>DMS â€¢ Orologio roadmap</small>
  </h1>

  <div id="glowLayer" aria-hidden="true"></div>
  <svg id="ellipseLayer" aria-hidden="true"></svg>
  <div id="viewport" role="region" aria-label="contenuti"></div>

<script>
/* ====== Bootstrap stabile senza flash 0,0 ======
   - Crea i nodi solo dopo aver calcolato layout
   - Posiziona i nodi con transform (nessun jump)
   - Ricalcola su resize e pageshow (bfcache)
================================================= */

(function(){
  const N = 12;
  let viewport, svg;
  let a=0, b=0, cx=0, cy=0, btnW=140;

  // Spotlight mouse (sotto i pulsanti)
  document.addEventListener('pointermove', e=>{
    const g = document.getElementById('glowLayer');
    if(!g) return;
    g.style.setProperty('--mx', e.clientX + 'px');
    g.style.setProperty('--my', e.clientY + 'px');
  }, {passive:true});

  function ensureHero(){
    if(!viewport) return;
    if (viewport.firstElementChild) return;
    const v = document.createElement('video');
    v.src = './videos/video-hero.mp4';
    v.muted = true; v.autoplay = true; v.loop = true;
    v.playsInline = true; v.setAttribute('playsinline','');
    v.preload = 'metadata';
    viewport.appendChild(v);
    v.play?.().catch(()=>{}); // iOS-safe
  }

  function layout(){
    viewport = document.getElementById('viewport');
    svg = document.getElementById('ellipseLayer');

    const W = innerWidth, H = innerHeight;
    cx = W/2; cy = H*0.52;

    // dimensione pulsanti coerente
    btnW = Math.max(96, Math.min(Math.round(W*0.09), 150));
    document.documentElement.style.setProperty('--btnW', btnW);

    // ellisse esterna
    a = Math.min(W*0.46, W/2-24);
    b = Math.min(H*0.34, H/2-36);

    // viewport 16:9 che entra nell'ellisse interna
    const innerA = a - btnW*0.60, innerB = b - btnW*0.60;
    let vw = W*0.62, vh = vw*9/16, maxH = H*0.44;
    if (vh > maxH){ vh = maxH; vw = vh*16/9; }
    let k=1;
    while(((((vw*k)/2)**2)/(innerA**2)+(((vh*k)/2)**2)/(innerB**2))>1 && k>0.4){ k-=0.02; }
    vw*=k; vh*=k;
    viewport.style.cssText = `width:${vw}px;height:${vh}px;left:${cx-vw/2}px;top:${cy-vh/2}px`;

    // disegna tacche e lancetta
    svg.setAttribute('viewBox',`0 0 ${W} ${H}`); svg.innerHTML='';
    const g=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(g);
    for(let i=0;i<N;i++){
      const t=-Math.PI/2 + 2*Math.PI*i/N;
      const ix=cx+(a-18)*Math.cos(t), iy=cy+(b-18)*Math.sin(t);
      const ex=cx+a*Math.cos(t),      ey=cy+b*Math.sin(t);
      const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
      ln.setAttribute('x1',ix); ln.setAttribute('y1',iy);
      ln.setAttribute('x2',ex); ln.setAttribute('y2',ey);
      ln.setAttribute('stroke','rgba(220,245,255,.6)');
      ln.setAttribute('stroke-width','2'); ln.setAttribute('stroke-linecap','round');
      g.appendChild(ln);
    }
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',10);
    c.setAttribute('fill','rgba(255,255,255,.7)'); g.appendChild(c);

    const hand=document.createElementNS('http://www.w3.org/2000/svg','line');
    hand.id='hand'; hand.setAttribute('x1',cx); hand.setAttribute('y1',cy);
    hand.setAttribute('x2',cx); hand.setAttribute('y2',cy);
    hand.setAttribute('stroke','rgba(255,255,255,.9)');
    hand.setAttribute('stroke-width','3'); hand.setAttribute('stroke-linecap','round');
    g.appendChild(hand);

    const tip=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    tip.id='handTip'; tip.setAttribute('fill','rgba(255,255,255,.9)'); g.appendChild(tip);

    let start=null; function anim(ts){
      if(!start) start=ts;
      const T=12000, th=-Math.PI/2 + 2*Math.PI*((ts-start)%T)/T;
      const px=cx+a*Math.cos(th)*0.95, py=cy+b*Math.sin(th)*0.95;
      hand.setAttribute('x2',px); hand.setAttribute('y2',py);
      const bx=cx+a*Math.cos(th)*0.86, by=cy+b*Math.sin(th)*0.86, nx=-Math.sin(th), ny=Math.cos(th), tipW=18;
      tip.setAttribute('points',`${px},${py} ${bx+nx*tipW},${by+ny*tipW} ${bx-nx*tipW},${by-ny*tipW}`);
      requestAnimationFrame(anim);
    }
    requestAnimationFrame(anim);
  }

  function createNodes(){
    // se giÃ  presenti, non duplicare
    if (document.querySelectorAll('.node').length) return;

    const frag = document.createDocumentFragment();
    for(let i=0;i<N;i++){
      const t = -Math.PI/2 + 2*Math.PI*i/N;
      const x = (a*Math.cos(t)) - (btnW/2);
      const y = (b*Math.sin(t)) - (btnW/2);
      const btt = document.createElement('button');
      btt.type='button'; btt.className='node'; btt.dataset.i=i;
      btt.style.setProperty('--x', (x)+'px');
      btt.style.setProperty('--y', (y)+'px');
      btt.innerHTML = `<span class="tag">PDF</span>`;
      btt.addEventListener('click', onNodeClick);
      frag.appendChild(btt);
    }
    document.body.appendChild(frag);
  }

  async function onNodeClick(e){
    const i = +e.currentTarget.dataset.i;
    const mods = await loadModules();
    const m = mods[i] || null;
    // viewport sempre dentro z-index 3
    if(!m || !m.pdf){
      const box=document.createElement('div');
      box.style.cssText="display:grid;place-items:center;height:100%;color:#cfe8f0;font-weight:800;font-size:1.2rem";
      box.textContent = 'Â· presto';
      viewport.innerHTML=''; viewport.appendChild(box);
      return;
    }
    // iframe PDF inline + due bottoni
    const wrap=document.createElement('div');
    wrap.style.cssText="display:flex;flex-direction:column;height:100%";
    const bar=document.createElement('div');
    bar.style.cssText="display:flex;gap:10px;padding:10px;background:rgba(0,0,0,.35)";
    const open=document.createElement('a');
    open.textContent='Apri in nuova scheda'; open.className='btn'; open.href=m.pdf; open.target='_blank';
    const back=document.createElement('button');
    back.textContent='Torna al video'; back.className='btn'; back.type='button';
    bar.append(open, back);

    const f=document.createElement('iframe');
    f.src=m.pdf; f.style.cssText="width:100%;height:100%;border:0;flex:1";

    wrap.append(bar, f);
    viewport.innerHTML=''; viewport.appendChild(wrap);
    back.onclick = ()=>{ viewport.innerHTML=''; ensureHero(); };
  }

  async function loadModules(){
    if (loadModules._cache) return loadModules._cache;
    try{
      const res = await fetch('./data/modules.json', {cache:'no-cache'});
      if(!res.ok) throw new Error('modules.json '+res.status);
      loadModules._cache = await res.json();
    }catch(e){
      console.warn('modules.json non disponibile:', e);
      loadModules._cache = [];
    }
    return loadModules._cache;
  }

  function bootstrap(){
    layout();         // calcola ellisse + viewport + lancetta
    ensureHero();     // garantisce video hero
    createNodes();    // crea i 12 pulsanti giÃ  nelle posizioni finali
  }

  // Primo avvio
  document.addEventListener('DOMContentLoaded', bootstrap);
  // Rientro da cronologia (Safari/iOS bfcache)
  window.addEventListener('pageshow', bootstrap, {once:true});
  // Ridimensionamento
  let t; window.addEventListener('resize', ()=>{ clearTimeout(t); t=setTimeout(()=>{
    // ricalcola posizioni e aggiorna nodi
    const nodes = document.querySelectorAll('.node');
    nodes.forEach(n=>n.remove());
    bootstrap();
  }, 80);});
})();
</script>

</body>
</html>

