<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DMS â€” Gemello Digitale del Commercio Â· Orologio</title>
<style>
  :root{
    --bg-a:#0e2d38; --bg-b:#155268;
    --ink:#dde2e4; --accent:#46a0bd;
    --glass:rgba(20,80,100,.56);
    --cardW:140px;
    --mx:50vw; --my:50vh; /* pos luce */
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 60% 20%, rgba(255,255,255,.06), transparent 60%),
      linear-gradient(180deg,var(--bg-b),var(--bg-a));
    font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overflow:hidden;
  }

  /* Spotlight che segue il cursore â€” sta SOTTO a svg/pulsanti */
  #cursorGlow{
    position:fixed; inset:0; pointer-events:none; z-index:1;
    background:
      radial-gradient(180px 180px at var(--mx) var(--my),
                      rgba(255,255,255,.16),
                      rgba(70,160,189,.09) 40%,
                      transparent 65%);
    transition:opacity .2s ease;
    opacity:.85;
  }

  .toolbar{
    position:fixed; left:20px; top:20px; display:flex; gap:8px; z-index:5;
  }
  .btn{
    appearance:none; border:none; cursor:pointer;
    padding:.56rem .9rem; border-radius:12px;
    color:var(--ink); background:var(--glass);
    border:2px solid rgba(255,255,255,.2);
    backdrop-filter: blur(6px);
    font-weight:700;
  }

  .claim{
    position:fixed; right:24px; top:28px; z-index:5;
    text-align:right; margin:0; line-height:1.1; letter-spacing:.02em;
  }
  .claim b{display:block; font-size:28px}
  .claim small{display:block; opacity:.82; font-size:14px; margin-top:6px}

  /* Layering: 1 glow (sotto), 2 svg, 3 viewport, 4 nodi */
  #ellipseLayer{ position:fixed; inset:0; z-index:2; pointer-events:none; }
  #ellipseLayer .tick{ stroke:rgba(220,245,255,.6); stroke-width:2; stroke-linecap:round }
  #ellipseLayer .center-dot{ fill:rgba(255,255,255,.8) }
  #hand{ stroke:rgba(255,255,255,.95); stroke-width:3; stroke-linecap:round }
  #handTip{ fill:rgba(255,255,255,.95) }

  .viewport{
    position:fixed; z-index:3;
    border-radius:20px; /* lasciamo overflow:visible per far "sbordare" il glow */
    overflow:visible;
    border:2px solid rgba(255,255,255,.28);
    background:rgba(0,0,0,.28);
    box-shadow: 0 20px 44px rgba(0,0,0,.42);
  }
  .viewport::before{ /* retro-illuminazione */
    content:""; position:absolute; inset:-34px; border-radius:28px;
    background:radial-gradient(260px 200px at 50% 18%, rgba(70,160,189,.42), transparent 65%);
    filter:blur(26px); opacity:.9; z-index:-1;
  }
  .viewport video,.viewport iframe{width:100%;height:100%;display:block;border:0;border-radius:inherit}

  .node{
    position:fixed; width:var(--cardW); height:var(--cardW);
    display:grid; place-items:center;
    border:2px solid rgba(190,230,240,.92);
    border-radius:16px; color:var(--ink);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    box-shadow:0 12px 24px rgba(0,0,0,.28);
    backdrop-filter: blur(4px);
    z-index:4; transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .node .tag{opacity:.92;font-weight:800;letter-spacing:.02em}
  /* Glow al passaggio + focus keyboard + active */
  .node::before{
    content:""; position:absolute; inset:-18px; border-radius:24px; z-index:-1;
    background:radial-gradient(120px 100px at 50% 30%, rgba(70,160,189,.48), transparent 60%);
    filter:blur(18px); opacity:0; transition:opacity .15s ease;
  }
  .node:hover, .node:focus-visible{ transform:translateY(-2px);
    box-shadow:0 16px 28px rgba(0,0,0,.36);
    border-color:rgba(255,255,255,.92);
  }
  .node:hover::before, .node:focus-visible::before, .node:active::before{ opacity:1 }

  @media (max-width:1200px){ :root{ --cardW:120px } }
  @media (max-width:820px){  :root{ --cardW:100px } }

  /* AccessibilitÃ : riduci le animazioni se richiesto */
  @media (prefers-reduced-motion: reduce){
    #ellipseLayer *{ transition:none!important; animation:none!important }
  }

  /* Niente (i) o tooltip eventualmente residui */
  .top-right small,.info,.tooltip,[data-tip],[aria-label],[title]{ display:none!important }
</style>
</head>
<body>

  <div id="cursorGlow" aria-hidden="true"></div>

  <div class="toolbar">
    <a class="btn" href="./index.html">ðŸŽ¬ Spot</a>
    <a class="btn" href="./mindmap.html">ðŸ§  Mappa</a>
  </div>

  <h1 class="claim">
    <b>GEMELLO DIGITALE</b>
    <b>DEL COMMERCIO</b>
    <small>DMS â€¢ Orologio roadmap</small>
  </h1>

  <svg id="ellipseLayer" aria-hidden="true"></svg>
  <div id="viewport" class="viewport" role="region" aria-label="contenuti"></div>

<script>
  /* ====== dati ====== */
  let modules=null, viewport=null, svg=null;

  async function loadModules(){
    if(modules) return modules;
    try{
      const res = await fetch('./data/modules.json?v=' + Date.now());
      if(!res.ok) throw new Error('modules.json ' + res.status);
      modules = await res.json();
    }catch(e){
      console.warn('modules.json non disponibile:', e);
      modules = [];
    }
    return modules;
  }

  /* ====== UI ====== */
  function makeNodes(){
    const frag = document.createDocumentFragment();
    for(let i=0;i<12;i++){
      const b = document.createElement('button');
      b.className='node'; b.dataset.i=i; b.type='button';
      b.innerHTML='<span class="tag">PDF</span>';
      b.addEventListener('click', onNodeClick);
      frag.appendChild(b);
    }
    document.body.appendChild(frag);
  }

  async function onNodeClick(e){
    const i=+e.currentTarget.dataset.i;
    const mods=await loadModules();
    const m=mods[i];
    viewport.innerHTML='';
    if(!m || !m.pdf){
      viewport.textContent='Â· presto';
      viewport.style.display='grid';
      viewport.style.placeItems='center';
      return;
    }
    // pannello PDF inline + comandi
    const bar=document.createElement('div');
    bar.style.cssText='position:absolute;right:10px;top:10px;z-index:10;display:flex;gap:8px';
    const open=document.createElement('a');
    open.className='btn'; open.textContent='Apri â†—'; open.target='_blank'; open.rel='noopener';
    open.href=m.pdf;
    const back=document.createElement('button');
    back.className='btn'; back.textContent='Torna al video'; back.onclick=()=>{ viewport.innerHTML=''; ensureHero(); };
    bar.append(open,back);
    const frame=document.createElement('iframe');
    frame.src=m.pdf; frame.loading='lazy';
    viewport.append(bar, frame);
  }

  function ensureHero(){
    viewport.innerHTML='';
    const v=document.createElement('video');
    v.src='./videos/video-hero.mp4';
    v.autoplay=true; v.loop=true; v.muted=true; v.playsInline=true; v.setAttribute('webkit-playsinline','');
    v.preload='metadata';
    viewport.appendChild(v);
    const tryPlay=()=>{
      v.play().catch(()=>setTimeout(tryPlay,300));
    };
    v.addEventListener('loadeddata', tryPlay, {once:true});
    tryPlay();
  }

  function layout(){
    viewport=document.getElementById('viewport');
    svg=document.getElementById('ellipseLayer');

    const W=innerWidth, H=innerHeight, cx=W/2, cy=H*0.50;
    // adattivo card + semiasse
    let card=Math.max(96, Math.min(Math.round(W*0.09), 150));
    document.documentElement.style.setProperty('--cardW', card+'px');

    const a=Math.min(W*0.46, W/2-24), b=Math.min(H*0.34, H/2-36);

    // viewport 16:9 che "entra" nell'ellisse interna
    const innerA=a-card*0.60, innerB=b-card*0.60;
    let vw=W*0.62, vh=vw*9/16, maxH=H*0.44;
    if(vh>maxH){ vh=maxH; vw=vh*16/9; }
    let k=1;
    while(((((vw*k)/2)**2)/(innerA**2)+(((vh*k)/2)**2)/(innerB**2))>1 && k>0.4){ k-=0.02; }
    vw*=k; vh*=k;
    viewport.style.cssText=`width:${vw}px;height:${vh}px;left:${cx-vw/2}px;top:${cy-vh/2}px`;

    // SVG orologio
    svg.setAttribute('viewBox',`0 0 ${W} ${H}`); svg.innerHTML='';
    const g=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(g);
    for(let i=0;i<12;i++){
      const t=-Math.PI/2 + 2*Math.PI*i/12;
      const ix=cx+(a-18)*Math.cos(t), iy=cy+(b-18)*Math.sin(t);
      const ex=cx+a*Math.cos(t),      ey=cy+b*Math.sin(t);
      const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
      ln.setAttribute('x1',ix); ln.setAttribute('y1',iy); ln.setAttribute('x2',ex); ln.setAttribute('y2',ey);
      ln.setAttribute('class','tick'); g.appendChild(ln);
    }
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',10);
    c.setAttribute('class','center-dot'); g.appendChild(c);

    const hand=document.createElementNS('http://www.w3.org/2000/svg','line');
    hand.id='hand'; hand.setAttribute('x1',cx); hand.setAttribute('y1',cy); g.appendChild(hand);
    const tip=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    tip.id='handTip'; g.appendChild(tip);

    // posiziona i 12 quadrati
    document.querySelectorAll('.node').forEach((el,i)=>{
      const t=-Math.PI/2 + 2*Math.PI*i/12;
      el.style.left=(cx + a*Math.cos(t) - card/2)+'px';
      el.style.top =(cy + b*Math.sin(t) - card/2)+'px';
    });

    // animazione lancetta con puntale
    let start=null; const T=12000;
    function anim(ts){
      if(!start) start=ts;
      const th=-Math.PI/2 + 2*Math.PI*((ts-start)%T)/T;
      const px=cx+a*Math.cos(th)*0.95, py=cy+b*Math.sin(th)*0.95; // punta
      const bx=cx+a*Math.cos(th)*0.80, by=cy+b*Math.sin(th)*0.80; // base
      hand.setAttribute('x2',px); hand.setAttribute('y2',py);
      const nx=-Math.sin(th), ny=Math.cos(th), tipW=16;
      tip.setAttribute('points',`${px},${py} ${bx+nx*tipW},${by+ny*tipW} ${bx-nx*tipW},${by-ny*tipW}`);
      requestAnimationFrame(anim);
    }
    requestAnimationFrame(anim);
  }

  /* Spotlight che segue il dito/mouse */
  (function setupCursorLight(){
    let raf=0, x=innerWidth/2, y=innerHeight/2;
    const update=()=>{ 
      document.documentElement.style.setProperty('--mx', x+'px');
      document.documentElement.style.setProperty('--my', y+'px');
      raf=0;
    };
    addEventListener('pointermove', e=>{
      x=e.clientX; y=e.clientY;
      if(!raf) raf=requestAnimationFrame(update);
    }, {passive:true});
    addEventListener('pointerdown', e=>{ x=e.clientX; y=e.clientY; update(); }, {passive:true});
  })();

  /* bootstrap */
  document.addEventListener('DOMContentLoaded', ()=>{
    makeNodes();
    layout();
    ensureHero();
  });
  addEventListener('resize', layout);
  addEventListener('pageshow', ensureHero);
</script>
</body>
</html>

