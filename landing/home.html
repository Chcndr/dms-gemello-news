<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>DMS • Orologio roadmap</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg1:#071a1d; --bg2:#0b2730;
      --ink:#e8fbff; --ink-2:#9bd6de;
      --accent:#14b8a6;
      --hc:#23b5a6; /* hover color default */
      
      /* scala armonica: rosso → arancio → giallo → giallo-verde → verde */
      --hc0:#e11d48;  /* rosso acceso */
      --hc1:#f97316;  /* arancio intenso */
      --hc2:#fb923c;  /* arancio chiaro */
      --hc3:#fbbf24;  /* ambra */
      --hc4:#eab308;  /* giallo scuro */
      --hc5:#d9f000;  /* giallo pieno */
      --hc6:#bde34a;  /* giallo-verde */
      --hc7:#9bdc4b;  /* verde-giallo */
      --hc8:#66c653;  /* verde medio */
      --hc9:#36b24a;  /* verde intenso */
      --hc10:#22a866; /* verde con punta teal */
      --hc11:#21c55d; /* verde acceso (finale) */
    }

    /* fondo */
    html,body{height:100%;margin:0}
    body{
      background: radial-gradient(1400px 900px at 50% 20%, #0f3640 0%, var(--bg1) 35%, var(--bg2) 100%);
      color:var(--ink); font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overflow:hidden;
    }

    /* nav+claim */
    .top{position:fixed; left:16px; top:16px; display:flex; gap:10px; z-index:10}
    .btn{
      padding:.55rem .9rem; border-radius:14px; border:1.5px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06); backdrop-filter: blur(6px);
      text-decoration:none; color:var(--ink); font-weight:600
    }
    .claim{position:fixed; right:20px; top:26px; text-align:right; z-index:10}
    .claim h1{margin:0 0 6px; letter-spacing:.02em; font-size:32px; line-height:1.1}
    .claim p{margin:0; color:var(--ink-2); font-weight:500}

    /* LAYER BLINDATI - layering sicuro */
    #glowLayer   { position:fixed; inset:0; z-index:1; pointer-events:none; }
    #ellipseLayer{ position:fixed; inset:0; z-index:2; pointer-events:none; }
    #viewport    { position:fixed;           z-index:3; }
    .node        { position:fixed; left:0; top:0; z-index:4; }

    /* Stile lancetta (dentro l'SVG #ellipseLayer) */
    #hand-shaft { stroke: rgba(255,255,255,.85); stroke-width: 4; stroke-linecap: round; }
    #hand-tip   { fill: rgba(255,255,255,.92); }

    /* Video */
    #viewport{
      display:flex; align-items:center; justify-content:center;
    }
    #viewport > video{
      width:100%; height:100%; object-fit:cover; border-radius:16px;
      box-shadow: 0 24px 60px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.08) inset;
      background:#0c1e25;
    }

    /* card neutra vetrosa - stile mockup */
    .node{
      position:absolute;
      width:140px; height:140px;
      border-radius:22px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:
        0 14px 34px rgba(0,0,0,.45),
        inset 0 0 0 1px rgba(255,255,255,.12);
      color:var(--ink); font-weight:600; letter-spacing:.02em;
      display:grid; place-items:center;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      will-change: transform, box-shadow;
      z-index:4; /* layer confermato */
    }
    .tag{opacity:.9}

    /* hover/focus con colore variabile per ogni pulsante */
    .node:is(:hover,:focus-visible){
      box-shadow:
        0 0 0 3px color-mix(in srgb, var(--hc) 90%, white 10%),
        0 0 32px 10px color-mix(in srgb, var(--hc) 65%, transparent),
        0 14px 34px rgba(0,0,0,.55),
        inset 0 0 0 1px rgba(255,255,255,.22);
      border-color: color-mix(in srgb, var(--hc) 70%, #fff 15%);
      transform: translateY(-2px);
    }

    /* alone leggero che segue il mouse */
    #glowLayer{
      background:
        radial-gradient(240px 240px at var(--mx,50%) var(--my,50%),
          rgba(20,184,166,.22), transparent 60%);
    }

    /* Puntale lancetta - RIMOSSO (ora in SVG) */

    /* Pannello PDF nel video - stile mockup */
    .panel{
      border-radius:28px;
      background:linear-gradient(180deg, rgba(8,34,38,.72), rgba(8,34,38,.62));
      box-shadow:
        0 30px 60px rgba(0,0,0,.50),
        inset 0 0 0 1px rgba(255,255,255,.10);
      backdrop-filter: blur(6px);
      color:#e6f7f4;
      padding: clamp(18px, 3vw, 28px);
    }

    /* titolo enorme */
    .panel h1{
      margin: 0 0 .6em 0;
      font-weight: 800;
      font-size: clamp(28px, 4.4vw, 56px);
      letter-spacing: .02em;
    }

    /* sottotitoli */
    .panel .lead{ font-size: clamp(16px,1.5vw,22px); opacity:.88; margin: .3em 0; }

    /* righe CTA PDF */
    .panel .cta{
      display:flex; align-items:center; gap:12px;
      margin-top:14px;
      padding:18px 22px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.08);
    }
    .panel .cta:hover{
      border-color: color-mix(in srgb, var(--accent) 60%, #fff 20%);
      box-shadow:
        0 0 0 2px color-mix(in srgb, var(--accent) 55%, transparent),
        inset 0 2px 0 rgba(255,255,255,.10);
      transform: translateY(-1px);
    }
    .panel .pdfdot{
      width:28px; height:28px; border-radius:8px;
      background: color-mix(in srgb, var(--accent) 22%, #0b1f22);
      display:grid; place-items:center; font-weight:700; font-size:12px;
      color:#cfeeea;
    }

    /* ---- SUPER CHIRURGIA PANEL FIX ------------------------------------ */
    /* Viewport resta com'è. Garantiamo però dimensione stabile con aspect-ratio */
    #viewport{
      position: relative;
      display: grid;
      place-items: center;
      z-index: 3;
      /* NON cambiare width/height esistenti: il panel usa inset:0 */
    }

    /* Video eroe: pieno del viewport */
    #hero, #viewport > video{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* Pannello: occupa ESATTAMENTE lo spazio del video */
    #panel.panel{
      position: absolute;
      inset: 0;                   /* stesso rettangolo del video */
      display: grid;
      align-content: start;
      padding: clamp(16px, 3vw, 28px);
      border-radius: inherit;
      background: color-mix(in srgb, var(--accent, #14b8a6) 10%, #0b1c20 92%);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 40px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
      opacity: 0;
      transform: scale(.985);
      pointer-events: none;
      transition: opacity .24s ease, transform .24s ease;
      z-index: 1; /* sopra al video, sotto ai .node perché è dentro il viewport */
      color: #e9f7f4;
    }
    #panel.panel.is-open{
      opacity: 1;
      transform: none;
      pointer-events: auto;
    }
    #panel .chip{
      display:inline-block;
      padding:.35rem .6rem;
      font-weight:600;
      border-radius:999px;
      background: color-mix(in srgb, var(--accent, #14b8a6) 38%, transparent);
      color:#cffff7;
    }
    #panel .btn{
      padding:.55rem .9rem;
      border-radius:.6rem;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#e9f7f4;
      backdrop-filter: blur(6px);
      cursor: pointer;
      text-decoration: none;
    }
    #panel .btn.btn-cta{
      background: var(--accent, #14b8a6);
      border-color: color-mix(in srgb, var(--accent, #14b8a6) 80%, #000 20%);
      color:#012a25;
      font-weight:700;
    }
    #panel .btn.ghost{
      background: rgba(255,255,255,.04);
    }

    /* Quando il pannello è aperto nascondiamo il video senza collasso */
    #hero.is-hidden, #viewport > video.is-hidden{ 
      opacity:0; 
      pointer-events:none; 
    }

    /* Testo bottoni Spot/Mappa sempre chiaro */
    .topbar .btn, .nav .btn, .spot-btn, .map-btn{
      color:#e6fffa !important;
    }

    /* Layering generale (non cambiare z-index esistenti altrove) */
    #glowLayer{ z-index:1; pointer-events:none; }
    #ellipseLayer{ z-index:2; pointer-events:none; }
    #viewport{ z-index:3; } /* video + panel */
    .node{ z-index:4; }     /* pulsanti */

    /* --- LIGHT TWEAK: pannello più luminoso e meno pesante --- */
    :root{
      --accent:#14b8a6;
      --accent-rgb:20,184,166;
    }

    /* Pannello: schiarito, meno opaco */
    #panel{
      /* niente cambio di posizionamento o misure */
      background:
        linear-gradient(180deg, rgba(15,32,36,0.88) 0%, rgba(16,35,39,0.84) 100%),
        #0f2024;                  /* prima era ~0.92/0.90: ora più luminoso */
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      /* ombra più leggera = meno lavoro GPU/CPU */
      box-shadow:0 16px 40px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.06);
      color:#e7fbf5;
      -webkit-font-smoothing:antialiased;
      backface-visibility:hidden;
      transform:translateZ(0);
    }

    /* Glow dietro: meno blur e meno intensità (migliore performance) */
    #panel::after{
      content:"";
      position:absolute; inset:-18px; pointer-events:none; z-index:0;
      background:
        radial-gradient(60% 70% at 50% 12%,
          rgba(var(--accent-rgb),.24) 0%, transparent 60%);
      filter:blur(12px);   /* prima ~22px */
      opacity:.32;         /* prima ~.55 */
    }

    /* Testi pannello un filo più chiari */
    #panel h1, #panel h2{ color:#f2fffb; }
    #panel p, #panel .meta{ color:#d6efe9; }

    /* Bottoni: alleggeriti (meno ombra) e senza filtri pesanti */
    .btn{
      box-shadow:0 6px 14px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06);
      background:rgba(255,255,255,.05);
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .btn--accent{
      background:linear-gradient(180deg, rgba(var(--accent-rgb),.16), rgba(var(--accent-rgb),.12));
      border-color:rgba(var(--accent-rgb),.38);
      box-shadow:0 10px 22px rgba(var(--accent-rgb),.16), inset 0 1px 0 rgba(255,255,255,.08);
    }
    .btn::after{ display:none; } /* rimuovo il glow extra sotto i bottoni (costoso) */

    /* Se l'utente preferisce meno animazioni, disattivale */
    @media (prefers-reduced-motion: reduce){
      .btn{ transition:none; }
    }

    /* Tasti orologio: titolo su 2 righe */
    .node { white-space: normal; line-height: 1.15; }
    .node .title { display:block; font-weight:700; }
    .node .sub   { display:block; font-size:.78em; opacity:.9; margin-top:2px; }
    /* Mantieni eventuale .tag già presente (es. "PDF") */

    /* Link PDF disattivati con eleganza */
    a.action[href="#"]{ pointer-events:none; opacity:.45; filter:grayscale(.15); cursor:default; }

    /* Pannello sicuro: più luminoso senza ::after */
    #panel{
      background:
        linear-gradient(180deg, rgba(15,32,36,.88) 0%, rgba(16,35,39,.84) 100%),
        #0f2024;
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 16px 40px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.06);
      color:#e7fbf5;
    }
    /* niente ::after finché non abbiamo verificato */
    #panel h1,#panel h2{color:#f2fffb}
    #panel p,.meta{color:#d6efe9}

    /* Punto di stato nel pannello Home */
    #panel{ position:relative; } /* safe */
    #panel::before{
      content:"";
      position:absolute; right:12px; top:12px;
      width:10px; height:10px; border-radius:50%;
      background:#14b8a6;                   /* teal DMS */
      box-shadow:0 0 0 2px rgba(20,184,166,.25), 0 0 10px rgba(20,184,166,.55);
      opacity:.9;
      pointer-events:none; z-index:1;
    }
    /* Variante in basso a destra: sostituisci con -> bottom:12px; top:auto; */
  </style>
</head>
<body>
  <!-- Nav -->
  <nav class="top">
    <a class="btn" href="../index.html">🎬 Spot</a>
    <a class="btn" href="../mindmap.html">🧠 Mappa</a>
  </nav>

  <!-- Claim -->
  <header class="claim">
    <h1>GEMELLO DIGITALE<br>DEL COMMERCIO</h1>
    <p>DMS • Orologio roadmap</p>
  </header>

  <!-- Layers -->
  <svg id="ellipseLayer" aria-hidden="true"></svg>
  <div id="viewport" aria-label="contenuti">
    <video id="heroVideo" src="../videos/video-hero.mp4"
      muted playsinline webkit-playsinline preload="metadata" autoplay loop
      poster="../assets/poster-hero.jpg"></video>
    
    <!-- PANEL dentro lo stesso viewport del video -->
    <section id="panel" class="panel" hidden aria-hidden="true">
      <div class="panel-body">
        <header class="panel-head">
          <span class="chip">Percorso</span>
          <h2 id="panel-title">Titolo modulo</h2>
        </header>
        <p id="panel-sub">Sottotitolo / descrizione breve.</p>

        <div class="panel-actions">
          <a id="panel-cta-0" class="btn btn-cta" href="#" target="_blank" rel="noopener">Apri PDF</a>
          <!-- altri CTA opzionali -->
          <button id="panel-close" class="btn ghost">Torna al video</button>
        </div>
      </div>
    </section>
  </div>
  <div id="glowLayer" aria-hidden="true"></div>

  <!-- 12 pulsanti ore 0..11 -->
  <button class="node" data-i="0"><span class="title">00 • I tre pilastri DMS</span><span class="sub">Amplia: Q4 2025</span><span class="tag">INFO</span></button>
  <button class="node" data-i="1"><span class="title">01 • Grosseto — collegamento</span><span class="sub">Amplia: Q1 2026</span><span class="tag">PDF</span></button>
  <button class="node" data-i="2"><span class="title">02 • ER — Hub pilota</span><span class="sub">Amplia: Q2 2026</span><span class="tag">PDF</span></button>
  <button class="node" data-i="3"><span class="title">03 • Pagamenti & integrazioni</span><span class="sub">Amplia: Q1 2026</span><span class="tag">INFO</span></button>
  <button class="node" data-i="4"><span class="title">04 • Passaporto EU (DPP)</span><span class="sub">Amplia: Q4 2026</span><span class="tag">INFO</span></button>
  <button class="node" data-i="5"><span class="title">05 • ECC — Narrativa</span><span class="sub">Amplia: Q4 2025</span><span class="tag">PDF</span></button>
  <button class="node" data-i="6"><span class="title">06 • ECC — Tecnica</span><span class="sub">Amplia: Q1 2026</span><span class="tag">INFO</span></button>
  <button class="node" data-i="7"><span class="title">07 • Carbon Credit (logica)</span><span class="sub">Amplia: Q4 2026</span><span class="tag">INFO</span></button>
  <button class="node" data-i="8"><span class="title">08 • Ecosistema Costi PA</span><span class="sub">Amplia: Q3 2026</span><span class="tag">INFO</span></button>
  <button class="node" data-i="9"><span class="title">09 • Analisi & Soluzione DMS</span><span class="sub">Amplia: Q1 2026</span><span class="tag">INFO</span></button>
  <button class="node" data-i="10"><span class="title">10 • Scenario futuro</span><span class="sub">Amplia: Q1 2027</span><span class="tag">INFO</span></button>
  <button class="node" data-i="11"><span class="title">11 • Hub Nazionale</span><span class="sub">Amplia: 2027</span><span class="tag">PDF</span></button>

  <!-- Puntale lancetta -->
  <div id="handTip" class="hand-tip" aria-hidden="true"></div>

  <script>
    (function(){
      const RATIO = 16/9;
      const BTN   = 140;
      const SAFE  = 48;
      const N     = 12;

      function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

      function layout(){
        const W  = innerWidth, H = innerHeight;
        const cx = W * 0.50;
        const cy = H * 0.52;

        // Spazio utile per i NODI dal centro ai bordi
        const Aroom = Math.min(cx, W-cx) - (SAFE + BTN/2);
        const Broom = Math.min(cy, H-cy) - (SAFE + BTN/2);

        // Dimensioni video massime
        let vhMaxFromNodes = 2 * (Broom - (BTN/2 + SAFE));
        let vwMaxFromNodes = 2 * (Aroom - (BTN/2 + SAFE));

        const vhMaxSoft = H * 0.40;
        const vwMaxSoft = W * 0.58;

        let vh = clamp(vhMaxFromNodes, 180, vhMaxSoft);
        let vw = Math.min(vh * RATIO, vwMaxSoft, vwMaxFromNodes);

        if (vw > vwMaxFromNodes) {
          vw = vwMaxFromNodes;
          vh = vw / RATIO;
        }

        // Riduci se serve più spazio ai nodi
        for (let k=0; k<8; k++){
          const topClear    = (cy - vh/2) - (SAFE + BTN/2);
          const bottomClear = (H - (cy + vh/2)) - (SAFE + BTN/2);
          if (Math.min(topClear, bottomClear) >= BTN*0.75) break;
          vh *= 0.90; vw = vh * RATIO;
        }

        // Applica il video centrato
        const vp = document.getElementById('viewport');
        vp.style.width  = vw + 'px';
        vp.style.height = vh + 'px';
        vp.style.left   = (cx - vw/2) + 'px';
        vp.style.top    = (cy - vh/2) + 'px';

        // Semi-assi ellisse OVALE: laterali quasi a bordo, verticali equilibrati
        const GAP = 80; // spazio tra video e pulsanti verticali
        const a = (W/2) - SAFE - (BTN/2); // semiasse orizzontale massimo
        const b = (vh/2) + GAP + (BTN/2);  // semiasse verticale equilibrato

        // Posiziona i 12 pulsanti
        const nodes = document.querySelectorAll('.node');
        nodes.forEach((el, i) => {
          const t = -Math.PI/2 + (2*Math.PI*i)/N;
          const x = cx + a * Math.cos(t) - BTN/2;
          const y = cy + b * Math.sin(t) - BTN/2;
          el.style.transform = `translate(${Math.round(x)}px,${Math.round(y)}px)`;
        });
      }

      layout();
      addEventListener('resize', layout, {passive:true});
      addEventListener('pageshow', layout);
    })();

    // spotlight mouse
    (function(){
      const glow = document.getElementById('glowLayer');
      let mx=0, my=0, ticking=false;
      addEventListener('pointermove', e => {
        mx=e.clientX; my=e.clientY;
        if(!ticking){
          requestAnimationFrame(()=>{ 
            glow.style.setProperty('--mx', mx+'px');
            glow.style.setProperty('--my', my+'px');
            ticking=false;
          });
          ticking=true;
        }
      }, {passive:true});
    })();

    // Puntale lancetta animato con asta - RIMOSSO (sostituito da handLayer)
  </script>

  <script>
    // Lancetta ellittica sotto al video + puntale
    (() => {
      const svg = document.getElementById('ellipseLayer');
      if (!svg) return;

      // Crea elementi (una sola volta) dentro l'SVG
      let shaft = svg.querySelector('#hand-shaft');
      let tip   = svg.querySelector('#hand-tip');
      if (!shaft) {
        shaft = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        shaft.setAttribute('id','hand-shaft');
        svg.appendChild(shaft);
      }
      if (!tip) {
        tip = document.createElementNS('http://www.w3.org/2000/svg','polygon');
        tip.setAttribute('id','hand-tip');
        svg.appendChild(tip);
      }

      // Utility: calcola ellisse usata anche per i pulsanti
      function computeEllipse() {
        const W = innerWidth, H = innerHeight;
        const cx = W/2;
        const cy = H*0.52;                 // stesso centro usato per i nodi
        const btn = 140;                   // diametro card approx (usa il tuo valore se in :root)
        const SAFE = 26;                   // margine sicurezza dal video/bordi
        const a = Math.min(W*0.44, W/2 - btn/2 - SAFE); // semiasse orizzontale
        const b = Math.min(H*0.34, H/2 - btn/2 - SAFE); // semiasse verticale
        return {cx, cy, a, b};
      }

      // Aggiorna dimensioni dell'SVG a tutto schermo
      function sizeSVG() {
        svg.setAttribute('width', innerWidth);
        svg.setAttribute('height', innerHeight);
        svg.setAttribute('viewBox', `0 0 ${innerWidth} ${innerHeight}`);
      }

      // Disegna lancetta all'angolo t (radiani) con puntale triangolare
      function drawHand(t) {
        const {cx, cy, a, b} = computeEllipse();

        // punta sulla traiettoria ellittica, arretrata di pochi px per non toccare i pulsanti
        const MARGIN = 18;
        const x2 = cx + (a - MARGIN) * Math.cos(t);
        const y2 = cy + (b - MARGIN) * Math.sin(t);

        // base in centro
        const x1 = cx, y1 = cy;

        // applica alla "asta"
        shaft.setAttribute('x1', x1);
        shaft.setAttribute('y1', y1);
        shaft.setAttribute('x2', x2);
        shaft.setAttribute('y2', y2);

        // puntale triangolare orientato lungo la direzione della lancetta
        const ang = Math.atan2(y2 - y1, x2 - x1);  // direzione
        const TIP_LEN = 16;                         // lunghezza punta
        const TIP_W   = 12;                         // larghezza base
        const bx = x2 - TIP_LEN * Math.cos(ang);   // centro base
        const by = y2 - TIP_LEN * Math.sin(ang);
        const nx =  Math.sin(ang), ny = -Math.cos(ang); // normale

        const p1x = x2,  p1y = y2;                                    // vertice punta
        const p2x = bx + (TIP_W/2) * nx, p2y = by + (TIP_W/2) * ny;   // base dx
        const p3x = bx - (TIP_W/2) * nx, p3y = by - (TIP_W/2) * ny;   // base sx
        tip.setAttribute('points', `${p1x},${p1y} ${p2x},${p2y} ${p3x},${p3y}`);
      }

      // Animazione continua (segue l'ovale, non un cerchio) – velocità dolce
      let t = -Math.PI/2;           // parte da ore 12
      function tick() {
        sizeSVG();
        drawHand(t);
        t += 0.008;                 // velocità (regola se serve)
        requestAnimationFrame(tick);
      }
      tick();

      // Re-layout su resize/bfcache
      addEventListener('resize',   () => { sizeSVG(); });
      addEventListener('pageshow', () => { sizeSVG(); });
    })();
  </script>

  <script>
(function(){
  const root   = document.documentElement;
  const panel  = document.getElementById('panel');
  const hero   = document.getElementById('hero');
  const back   = document.getElementById('panel-back');

  function safeHref(u){ try { return encodeURI(u); } catch { return '#'; } }

  function buildLinks(meta){
    const links = [];
    if(meta?.pdf) links.push(['Apri documento principale (PDF)', meta.pdf]);
    (meta?.more||[]).forEach((u,idx)=> links.push([`Apri allegato ${idx+1} (PDF)`, u]));
    return links.map(([label, href]) =>
      `<a class="btn" href="${safeHref(href)}" target="_blank" rel="noopener">${label}</a>`
    ).join(' ');
  }

  window.__openPanelByIndex = function(i, meta){
    const node = document.querySelector(`.node[data-i="${i}"]`) || document.querySelectorAll('.node')[i];
    const c = node ? getComputedStyle(node).getPropertyValue('--hc').trim() : '#14b8a6';
    root.style.setProperty('--accent', c || '#14b8a6');

    document.getElementById('panel-title').textContent = meta?.title || `Modulo ${i}`;
    document.getElementById('panel-sub').textContent   = meta?.when || meta?.desc || 'In sviluppo';
    document.getElementById('panel-body').innerHTML    = buildLinks(meta);

    // misura dal hero e mostra
    const r = hero.getBoundingClientRect();
    root.style.setProperty('--vw', r.width + 'px');
    root.style.setProperty('--vh', r.height + 'px');

    panel.hidden = false;
    document.body.classList.add('panel-open');
    hero.style.visibility = 'hidden';
  };

  function closePanel(){ panel.hidden = true; document.body.classList.remove('panel-open'); hero.style.visibility=''; }
  back?.addEventListener('click', closePanel);

  addEventListener('resize', ()=>{ if(panel && !panel.hidden){ const r = hero.getBoundingClientRect(); root.style.setProperty('--vw', r.width + 'px'); root.style.setProperty('--vh', r.height + 'px'); } }, {passive:true});
})();

    // Integrazione click nodi con pannelli
    document.querySelectorAll('.node').forEach((el, i) => {
      el.addEventListener('click', () => {
        // Carica modules.json se non già caricato
        if (!window.MODULES) {
          fetch('./data/modules.json')
            .then(r => r.json())
            .then(data => {
              window.MODULES = data;
              const meta = window.MODULES[i];
              window.__openPanelByIndex(i, meta);
            })
            .catch(() => window.__openPanelByIndex(i, null));
        } else {
          const meta = window.MODULES[i];
          window.__openPanelByIndex(i, meta);
        }
      });
    });
  </script>

  <script>
    (function applyHoverPalette(){
      const root = getComputedStyle(document.documentElement);
      document.querySelectorAll('.node').forEach((el, i)=>{
        const v = root.getPropertyValue(`--hc${i}`).trim();
        el.style.setProperty('--hc', v || '#23b5a6'); // fallback teal
      });
    })();
  </script>

  <script>
(function(){
  const vp   = document.getElementById('viewport');
  const hero = document.getElementById('hero') || vp.querySelector('video');
  const panel= document.getElementById('panel');

  // Anti-flicker: non cambiare layout; il video resta montato, solo opacity
  if(hero){
    hero.preload = hero.preload || 'metadata';
    if(!hero.poster) hero.poster = './assets/poster-hero.jpg'; // se esiste
    hero.muted = true; hero.playsInline = true;
  }

  // Apri pannello per indice i e colore accent
  window.openPanelByIndex = function(i, accent, data){
    if(!panel) return;

    // Colore accent dal tasto (fallback teal)
    panel.style.setProperty('--accent', accent || '#14b8a6');

    // (Opzionale) riempi contenuti
    if(data){
      panel.querySelector('#panel-title').textContent = data.title || ('Modulo ' + i);
      panel.querySelector('#panel-sub').textContent   = data.sub   || 'Contenuti in arrivo.';
      if(data.pdf){
        const a0 = panel.querySelector('#panel-cta-0');
        a0.href = data.pdf; a0.style.display = '';
      }
    } else {
      // Fallback se non ci sono dati
      panel.querySelector('#panel-title').textContent = 'Modulo ' + i;
      panel.querySelector('#panel-sub').textContent = 'Contenuti in arrivo.';
    }

    hero && hero.classList.add('is-hidden');
    panel.hidden = false;
    panel.classList.add('is-open');
  };

  // Chiudi pannello
  function closePanel(){
    panel.classList.remove('is-open');
    // piccola attesa per la transizione, poi nascondo
    setTimeout(()=>{ panel.hidden = true; }, 240);
    hero && hero.classList.remove('is-hidden');
  }

  // Wire del bottone "Torna al video"
  const btnClose = document.getElementById('panel-close');
  if(btnClose) btnClose.addEventListener('click', closePanel);

  // Collega i 12 tasti dell'orologio
  document.querySelectorAll('.node').forEach((el, i) => {
    el.addEventListener('click', (e) => { 
      e.preventDefault(); 
      const accent = getComputedStyle(el).getPropertyValue('--hc').trim() || '#14b8a6';
      openPanelByIndex(i, accent, null); 
    }, {passive:false});
  });

  // Test veloce ?panel=i
  const qs = new URLSearchParams(location.search);
  if (qs.has('panel')) { 
    const i = parseInt(qs.get('panel'),10)||0;
    const accent = '#14b8a6'; // colore di default per test
    openPanelByIndex(i, accent, null); 
  }
})();
  </script>
</body>
</html>

