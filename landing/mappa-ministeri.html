<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<title>Mappa Ministeri ‚Äî sandbox</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="build" content="STABLE-20250903-MAP-LIVE" />
<style>
  :root{
    --bg:#07181c; --ink:#e7fbf5; --muted:#a6cfc6;
    --stroke:#1e2a2e; --glass:#0f2024ee; --chip:#0b1d20; --accent:#14b8a6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(60% 70% at 50% 12%, rgba(20,184,166,.10) 0%, transparent 60%), var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  a{color:inherit;text-decoration:none}
  .nav{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;padding:12px 16px;background:linear-gradient(180deg, rgba(7,24,28,.85) 0%, rgba(7,24,28,.35) 100%)}
  .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--chip);box-shadow:0 6px 14px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06)}
  .btn:hover{outline:1px solid rgba(255,255,255,.06)}
  .title{margin-left:auto;margin-right:auto;font-weight:700;letter-spacing:.3px}
  .wrap{max-width:1280px;margin:0 auto;padding:0 16px 48px}
  #stageWrap{position:relative;border:1px solid var(--stroke);border-radius:16px;padding:12px;background:radial-gradient(60% 70% at 50% 12%, rgba(20,184,166,.08) 0%, transparent 60%);}
  #stage{position:relative; height:68vh; min-height:520px; border-radius:12px; overflow:hidden}
  .node{position:absolute; padding:10px 12px; min-width:140px; text-align:center; background:rgba(15,32,36,.70); backdrop-filter:blur(6px); border:1px solid var(--stroke); border-radius:14px; cursor:pointer; user-select:none; transform:translate(-50%,-50%); will-change:transform, box-shadow}
  .node:hover{box-shadow:0 6px 18px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.06) inset}
  .node.ring1{background:rgba(15,32,36,.66)}
  .node.ring2{background:rgba(15,32,36,.55)}
  .node.center{font-weight:700; border:1px solid rgba(20,184,166,.35); box-shadow:0 0 0 1px rgba(20,184,166,.15) inset, 0 0 60px rgba(20,184,166,.12)}
  .tag{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;opacity:.9}
  #svg{position:absolute; inset:0; pointer-events:none}
  .ring{fill:none; stroke:rgba(255,255,255,.06)}
  .edge{stroke:rgba(20,184,166,.18); stroke-width:1}
  .panel{margin-top:16px; padding:16px; border:1px solid var(--stroke); border-radius:12px; background:var(--glass)}
  .panel h3{margin:0 0 8px}
  .meta{color:var(--muted); font-size:14px; margin:2px 0 12px}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--chip)}
  .chip .k{opacity:.65}
  .docs{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .doc{display:inline-flex;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip)}
  .doc small{opacity:.7;margin-left:6px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto}
  .switch{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px dashed var(--stroke);border-radius:999px;opacity:.9}
  .legend{margin-top:8px; font-size:13px; color:var(--muted)}
  @media (max-width:720px){
    .node{min-width:120px}
    #stage{height:64vh; min-height:480px}
  }
</style>
</head>
<body>
  <div class="nav">
    <a class="btn" href="/dms-gemello-news/landing/home.html" target="_top">‚Üê Home</a>
    <a class="btn" href="/dms-gemello-news/" target="_top">üìö Spot</a>
    <div class="controls">
      <label class="switch"><input id="auto" type="checkbox" checked> Auto-rotate</label>
      <label class="switch"><input id="lines" type="checkbox" checked> Linee</label>
    </div>
    <div class="title">Mappa Ministeri (sandbox)</div>
  </div>

  <div class="wrap">
    <div id="stageWrap">
      <svg id="svg" viewBox="0 0 1000 680" preserveAspectRatio="none" aria-hidden="true"></svg>
      <div id="stage" aria-label="Mappa radiale interattiva"></div>
    </div>

    <div id="sheet" class="panel" hidden>
      <h3 class="ttl"></h3>
      <p class="meta"></p>
      <div class="chips"></div>
      <h4 style="margin:16px 0 6px">Documenti</h4>
      <div class="docs"></div>
      <p class="legend">Suggerimento: i link "Apri su Spot" evidenziano la card nella libreria; "Apri PDF" apre direttamente il documento (eventuale pagina prefissata).</p>
    </div>
  </div>

<script>
(async function(){
  // --- 1) Dati --------------------------------------------------------------
  const DATA_URL = '/dms-gemello-news/landing/data/ministeri.json?v=2';
  let DATA = [];
  try{
    const r = await fetch(DATA_URL, {cache:'no-store'}); DATA = await r.json();
  }catch(e){ console.error('ministeri.json', e); }

  // --- 2) Layout radiale ----------------------------------------------------
  const stage = document.getElementById('stage');
  const svg = document.getElementById('svg');
  const W = stage.clientWidth, H = stage.clientHeight;
  const cx = W/2, cy = H/2;
  const R1 = Math.min(W,H)*0.30;   // raggio anello Ministeri
  const R2 = Math.min(W,H)*0.42;   // raggio anello Enti/PA
  const rings = [0,R1,R2];

  // SVG rings + edges
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  const sNS = 'http://www.w3.org/2000/svg';
  const g = document.createElementNS(sNS,'g');
  [R1,R2].forEach(r=>{
    const c = document.createElementNS(sNS,'circle');
    c.setAttribute('class','ring'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r);
    g.appendChild(c);
  });
  svg.appendChild(g);

  // center node
  const center = mkNode({id:'pcm', nome:'PCM ¬∑ Presidenza del Consiglio', ring:0, tag:'Hub'});
  place(center, cx, cy); center.classList.add('center'); stage.appendChild(center);

  // split rings
  const ring1 = DATA.filter(d => (d.ring||1)==1);
  const ring2 = DATA.filter(d => (d.ring||2)==2);

  distribute(ring1, R1, 'ring1');
  distribute(ring2, R2, 'ring2');

  function distribute(items, R, klass){
    const n = items.length;
    items.forEach((m, i)=>{
      const ang = (i/n)*2*Math.PI - Math.PI/2;
      const x = cx + R*Math.cos(ang), y = cy + R*Math.sin(ang);
      const el = mkNode(m); el.classList.add(klass);
      place(el, x, y); stage.appendChild(el);
      drawEdge(cx, cy, x, y, m);
    });
  }

  function mkNode(m){
    const el = document.createElement('div');
    el.className = 'node';
    el.dataset.id = m.id;
    el.innerHTML = `<div>${m.nome}</div>${m.tag?`<span class="tag">${m.tag}</span>`:''}`;
    el.addEventListener('click', ()=> openSheet(m));
    return el;
  }
  function place(el,x,y){ el.style.left=x+'px'; el.style.top=y+'px'; }
  function drawEdge(x1,y1,x2,y2,m){
    const line = document.createElementNS(sNS,'line');
    line.setAttribute('x1',x1); line.setAttribute('y1',y1);
    line.setAttribute('x2',x2); line.setAttribute('y2',y2);
    line.setAttribute('class','edge'); line.dataset.id=m.id;
    svg.appendChild(line);
  }

  // --- 3) Sheet -------------------------------------------------------------
  const sheet = document.getElementById('sheet');
  function openSheet(m){
    sheet.hidden = false;
    sheet.querySelector('.ttl').textContent = m.nome || '';
    sheet.querySelector('.meta').textContent = [
      m.problema ? `Problema: ${m.problema}` : null,
      m.soluzione? `Soluzione: ${m.soluzione}`: null,
      m.risultati? `Risultati: ${m.risultati}`: null,
      m.norme?    `Norme: ${m.norme}`: null
    ].filter(Boolean).join(' ‚Ä¢ ');

    // chips collegamenti
    const chips = sheet.querySelector('.chips');
    chips.innerHTML = '';
    (m.collegamenti||[]).forEach(c=>{
      const span = document.createElement('span');
      span.className='chip';
      span.innerHTML = `<span class="k">‚ÜóÔ∏é</span>${c}`;
      chips.appendChild(span);
    });

    // documenti
    const box = sheet.querySelector('.docs');
    box.innerHTML='';
    (m.docs||[]).forEach(d=>{
      const a = document.createElement('a');
      a.className='doc'; a.target='_top';
      const spot = `/dms-gemello-news/#doc-${d.slug}`;
      const pdf  = `/dms-gemello-news/docs/${d.slug}.pdf${d.page?`#page=${d.page}`:''}`;
      if(d.open==='pdf'){ a.href = pdf; a.textContent = d.label || 'Apri PDF'; }
      else { a.href = spot; a.textContent = d.label || 'Apri su Spot'; a.title='Apri scheda su Spot'; }
      if(d.page && d.open!=='pdf'){ const s = document.createElement('small'); s.textContent = ` ¬∑ pag ${d.page}`; a.appendChild(s); }
      box.appendChild(a);
    });
  }

  // --- 4) Piccole interazioni: auto-rotate & line toggle --------------------
  const auto = document.getElementById('auto');
  const lines = document.getElementById('lines');
  lines.addEventListener('change', ()=> svg.style.opacity = lines.checked ? '1' : '0');

  let t = 0, raf;
  function tick(){
    t += 0.002;
    if(!auto.checked){ raf = requestAnimationFrame(tick); return; }
    rotateRing('.ring1', R1, ring1.length,  t);
    rotateRing('.ring2', R2, ring2.length, -t*0.8);
    raf = requestAnimationFrame(tick);
  }
  function rotateRing(cls, R, n, phi){
    const nodes = stage.querySelectorAll('.node'+cls);
    nodes.forEach((el, i)=>{
      const ang = (i/n)*2*Math.PI + phi - Math.PI/2;
      const x = cx + R*Math.cos(ang), y = cy + R*Math.sin(ang);
      place(el, x, y);
      const L = svg.querySelector(`.edge[data-id="${el.dataset.id}"]`);
      if(L){ L.setAttribute('x2',x); L.setAttribute('y2',y); }
    });
  }
  tick();
})();
</script>
</body>
</html>

