<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<title>Mappa Ministeri ‚Äî sandbox</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="build" content="STABLE-20250903-MAP-LIVE" />
<style>
  :root{
    --ink:#e6ecee; --bg:#030a0c;
    --stroke:#1e2a2e; --glass:#0f2024ee; --chip:#0b1d20; --accent:#14b8a6;
    /* tile reattiva: da 148px a 220px */
    --node: clamp(148px, 10.5vw, 220px);
    --radius: 16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(60% 70% at 50% 12%, rgba(20,184,166,.10) 0%, transparent 60%), var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  a{color:inherit;text-decoration:none}
  .nav{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;padding:12px 16px;background:linear-gradient(180deg, rgba(7,24,28,.85) 0%, rgba(7,24,28,.35) 100%)}
  .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--chip);box-shadow:0 6px 14px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06)}
  .btn:hover{outline:1px solid rgba(255,255,255,.06)}
  .title{margin-left:auto;margin-right:auto;font-weight:700;letter-spacing:.3px}
  .wrap{max-width:1280px;margin:0 auto;padding:0 16px 48px}
  #stageWrap{position:relative;border:1px solid var(--stroke);border-radius:16px;padding:12px;background:radial-gradient(60% 70% at 50% 12%, rgba(20,184,166,.08) 0%, transparent 60%); height: 74vh;}
  #stage{position:relative; height:100%; min-height:520px; border-radius:12px; overflow:hidden}
  
  /* tile ovale */
  .node{
    position:absolute; transform:translate(-50%,-50%);
    width:var(--node); height:var(--node);
    display:flex; align-items:center; justify-content:center; text-align:center;
    padding:14px; border-radius:var(--radius);
    background:rgba(15,32,36,.72); border:1px solid var(--stroke);
    box-shadow:0 6px 18px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.06) inset;
    cursor:pointer; user-select:none; will-change: transform;
  }
  .node:hover{ box-shadow:0 8px 22px rgba(0,0,0,.30), 0 0 0 1px rgba(255,255,255,.10) inset; }
  .node .label{font-weight:700; line-height:1.2}
  .node .tag{display:block;margin-top:6px;opacity:.8}
  
  /* centro: icona ministero con glow blu PA */
  .node.center{
    border:1px solid rgba(20,184,166,.35);
    background: radial-gradient(60% 70% at 50% 12%, rgba(30,144,255,.18) 0%, transparent 70%),
                rgba(15,32,36,.78);
  }
  .node.center::before{
    content:""; position:absolute; inset:22% 22%;
    background:url('/dms-gemello-news/landing/img/ministero.svg') center/contain no-repeat;
    filter: drop-shadow(0 0 18px rgba(30,144,255,.35));
    opacity:.95;
  }
  
  /* foglio/scheda fullscreen */
  #modal{position:fixed; inset:0; background:rgba(3,10,12,.72); backdrop-filter:blur(6px);
    display:none; align-items:center; justify-content:center; z-index:9999;}
  #card{width:min(1080px,92vw); max-height:88vh; overflow:auto;
    background:#0f2024ee; border:1px solid var(--stroke); border-radius:18px; padding:18px;}
  #card .hero{width:100%; max-height:320px; object-fit:cover; border-radius:12px; margin-bottom:12px;}
  #card h2{margin:6px 0 8px}
  #card .grid{display:grid; grid-template-columns: 1.4fr 1fr; gap:16px;}
  #card .docs{display:flex; flex-wrap:wrap; gap:8px;}
  #close{position:sticky; top:0; float:right; margin:-6px -6px 6px 6px}
  @media (max-width: 900px){ #card .grid{grid-template-columns:1fr} }
  
  #svg{position:absolute; inset:0; pointer-events:none}
  .ring{fill:none; stroke:rgba(255,255,255,.06)}
  .edge{stroke:rgba(20,184,166,.18); stroke-width:1}
  .panel{margin-top:16px; padding:16px; border:1px solid var(--stroke); border-radius:12px; background:var(--glass)}
  .panel h3{margin:0 0 8px}
  .meta{color:var(--muted); font-size:14px; margin:2px 0 12px}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--chip)}
  .chip .k{opacity:.65}
  .docs{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .doc{display:inline-flex;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip)}
  .doc small{opacity:.7;margin-left:6px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto}
  .switch{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px dashed var(--stroke);border-radius:999px;opacity:.9}
  .legend{margin-top:8px; font-size:13px; color:var(--muted)}
  @media (max-width:720px){
    .node{width:calc(var(--node) * 0.8); height:calc(var(--node) * 0.8)}
    #stage{height:64vh; min-height:480px}
  }
</style>
</head>
<body>
  <div class="nav">
    <a class="btn" href="/dms-gemello-news/landing/home.html" target="_top">‚Üê Home</a>
    <a class="btn" href="/dms-gemello-news/" target="_top">üìö Spot</a>
    <div class="controls">
      <label class="switch"><input id="auto" type="checkbox" checked> Auto-rotate</label>
      <label class="switch"><input id="lines" type="checkbox" checked> Linee</label>
      <input id="q" placeholder="Cerca ministero‚Ä¶" style="margin-left:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip);color:var(--ink);">
    </div>
    <div class="title">Mappa Ministeri (sandbox)</div>
  </div>

  <div class="wrap">
    <div id="stageWrap">
      <svg id="svg" viewBox="0 0 1000 680" preserveAspectRatio="none" aria-hidden="true"></svg>
      <div id="stage" aria-label="Mappa radiale interattiva"></div>
    </div>

    <div id="sheet" class="panel" hidden>
      <h3 class="ttl"></h3>
      <p class="meta"></p>
      <div class="chips"></div>
      <h4 style="margin:16px 0 6px">Documenti</h4>
      <div class="docs"></div>
      <p class="legend">Suggerimento: i link "Apri su Spot" evidenziano la card nella libreria; "Apri PDF" apre direttamente il documento (eventuale pagina prefissata).</p>
    </div>
  </div>

  <!-- Fullscreen Sheet -->
  <div id="modal" aria-hidden="true">
    <div id="card">
      <button id="close" class="btn">‚úï Chiudi</button>
      <img class="hero" alt="" />
      <h2 class="ttl"></h2>
      <div class="grid">
        <div>
          <p class="meta"></p>
          <ul class="bullets"></ul>
        </div>
        <div>
          <h4>Documenti</h4>
          <div class="docs"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(async function(){
  // --- 1) Dati --------------------------------------------------------------
  const DATA_URL = '/dms-gemello-news/landing/data/ministeri.json?v=2';
  let DATA = [];
  try{
    const r = await fetch(DATA_URL, {cache:'no-store'}); DATA = await r.json();
  }catch(e){ console.error('ministeri.json', e); }

  // mostriamo SOLO questi id (PDF pilastro)
  const SHOW = ['pcm','mef','interno','mimit','mase','mit','salute','maeci','agid','pagopa','ae','adm'];

  // --- 2) Layout radiale ----------------------------------------------------
  const stage = document.getElementById('stage');
  const svg = document.getElementById('svg');
  const W = stage.clientWidth, H = stage.clientHeight;
  const cx = W/2, cy = H/2;
  const R1 = Math.min(W,H)*0.30;   // raggio anello Ministeri
  const R2 = Math.min(W,H)*0.42;   // raggio anello Enti/PA
  const rings = [0,R1,R2];

  // SVG rings + edges
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  const sNS = 'http://www.w3.org/2000/svg';
  const g = document.createElementNS(sNS,'g');
  [R1,R2].forEach(r=>{
    const c = document.createElementNS(sNS,'circle');
    c.setAttribute('class','ring'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r);
    g.appendChild(c);
  });
  svg.appendChild(g);

  // center node
  const center = mkNode({id:'pcm', nome:'PCM ¬∑ Presidenza del Consiglio', ring:0, tag:'Hub'});
  place(center, cx, cy); center.classList.add('center'); stage.appendChild(center);

  // filtra i ministeri in base alla whitelist
  const ALL = DATA.filter(m => SHOW.includes(m.id));
  const ring1 = ALL.filter(d => (d.ring||1) === 1);
  const ring2 = ALL.filter(d => (d.ring||2) === 2);

  distribute(ring1, R1, 'ring1');
  distribute(ring2, R2, 'ring2');

  function distribute(items, R, klass){
    const n = items.length;
    items.forEach((m, i)=>{
      const ang = (i/n)*2*Math.PI - Math.PI/2;
      const x = cx + R*Math.cos(ang), y = cy + R*Math.sin(ang);
      const el = mkNode(m); el.classList.add(klass);
      place(el, x, y); stage.appendChild(el);
      drawEdge(cx, cy, x, y, m);
    });
  }

  function mkNode(m){
    const el = document.createElement('div');
    el.className = 'node';
    el.dataset.id = m.id;
    el.innerHTML = `<div class="label">${m.nome}</div>${m.tag?`<span class="tag">${m.tag}</span>`:''}`;
    el.addEventListener('click', ()=> openFull(m));
    return el;
  }
  function place(el,x,y){ el.style.left=x+'px'; el.style.top=y+'px'; }
  function drawEdge(x1,y1,x2,y2,m){
    const line = document.createElementNS(sNS,'line');
    line.setAttribute('x1',x1); line.setAttribute('y1',y1);
    line.setAttribute('x2',x2); line.setAttribute('y2',y2);
    line.setAttribute('class','edge'); line.dataset.id=m.id;
    svg.appendChild(line);
  }

  // --- 3) Scheda fullscreen -------------------------------------------------
  const modal = document.getElementById('modal');
  const imgHero = modal.querySelector('.hero');
  const ttl = modal.querySelector('.ttl');
  const meta = modal.querySelector('.meta');
  const bullets = modal.querySelector('.bullets');
  const docsBox = modal.querySelector('.docs');
  document.getElementById('close').onclick = ()=> modal.style.display='none';

  function openFull(m){
    modal.style.display = 'flex';
    ttl.textContent = m.nome || '';

    // breve linea descrittiva
    meta.textContent = [
      m.problema && `Problema: ${m.problema}`,
      m.soluzione && `Soluzione: ${m.soluzione}`,
      m.risultati && `Risultati: ${m.risultati}`
    ].filter(Boolean).join(' ‚Ä¢ ');

    // punti elenco (narrativa/valore)
    bullets.innerHTML = '';
    (m.punti||[]).forEach(t => {
      const li = document.createElement('li'); li.textContent = t; bullets.appendChild(li);
    });

    // hero illustrata (se manca, nascondi)
    if(m.hero){ imgHero.src = m.hero; imgHero.alt = m.alt || ''; imgHero.style.display='block'; }
    else { imgHero.style.display='none'; }

    // documenti (Spot o PDF diretto con #page)
    docsBox.innerHTML='';
    (m.docs||[]).forEach(d=>{
      const a = document.createElement('a'); a.className='doc'; a.target='_top';
      const spot = `/dms-gemello-news/#doc-${d.slug}`;
      const pdf  = `/dms-gemello-news/docs/${d.slug}.pdf${d.page?`#page=${d.page}`:''}`;
      a.href = d.open==='pdf' ? pdf : spot;
      a.textContent = d.label || (d.open==='pdf' ? 'Apri PDF' : 'Apri su Spot');
      if(d.page && d.open!=='pdf'){ const s=document.createElement('small'); s.textContent=` ¬∑ pag ${d.page}`; a.appendChild(s); }
      docsBox.appendChild(a);
    });
  }

  // --- 4) Sheet legacy (mantenuto per compatibilit√†) ----------------------
  const sheet = document.getElementById('sheet');
  function openSheet(m){
    sheet.hidden = false;
    sheet.querySelector('.ttl').textContent = m.nome || '';
    sheet.querySelector('.meta').textContent = [
      m.problema ? `Problema: ${m.problema}` : null,
      m.soluzione? `Soluzione: ${m.soluzione}`: null,
      m.risultati? `Risultati: ${m.risultati}`: null,
      m.norme?    `Norme: ${m.norme}`: null
    ].filter(Boolean).join(' ‚Ä¢ ');

    // chips collegamenti
    const chips = sheet.querySelector('.chips');
    chips.innerHTML = '';
    (m.collegamenti||[]).forEach(c=>{
      const span = document.createElement('span');
      span.className='chip';
      span.innerHTML = `<span class="k">‚ÜóÔ∏é</span>${c}`;
      chips.appendChild(span);
    });

    // documenti
    const box = sheet.querySelector('.docs');
    box.innerHTML='';
    (m.docs||[]).forEach(d=>{
      const a = document.createElement('a');
      a.className='doc'; a.target='_top';
      const spot = `/dms-gemello-news/#doc-${d.slug}`;
      const pdf  = `/dms-gemello-news/docs/${d.slug}.pdf${d.page?`#page=${d.page}`:''}`;
      if(d.open==='pdf'){ a.href = pdf; a.textContent = d.label || 'Apri PDF'; }
      else { a.href = spot; a.textContent = d.label || 'Apri su Spot'; a.title='Apri scheda su Spot'; }
      if(d.page && d.open!=='pdf'){ const s = document.createElement('small'); s.textContent = ` ¬∑ pag ${d.page}`; a.appendChild(s); }
      box.appendChild(a);
    });
  }

  // ---- stato globale
  let cx=0, cy=0, Rx1=0, Ry1=0, Rx2=0, Ry2=0;
  let phase=0, speed=0.0016;   // rad/frame
  let scale=1, rotating=true;
  const SHOW = ['pcm','mef','interno','mimit','mase','mit','salute','maeci','agid','pagopa','ae','adm']; // solo pilastro PDF

  // ---- util
  function place(el,x,y){ el.style.transform=`translate(${x}px,${y}px)`; }
  function ellipseXY(rx, ry, a){ return [cx + rx*Math.cos(a), cy + ry*Math.sin(a)]; }
  function jitter(i){ return (i%2? +0.06 : -0.06); } // ~3.4¬∞ alternati

  // ---- layout reattivo (ovale)
  function layout(){
    const rect = document.getElementById('stage').getBoundingClientRect();
    cx=rect.width/2; cy=rect.height/2;
    const S = Math.min(rect.width, rect.height);
    Rx1 = S*0.36*scale;  Ry1 = rect.height*0.28*scale;   // anello interno
    Rx2 = S*0.46*scale;  Ry2 = rect.height*0.36*scale;   // esterno
    redraw();
  }

  // ---- posizionamento su ovale
  function distribute(items, rx, ry, klass){
    const n=items.length;
    items.forEach((m,i)=>{
      const a = (i/n)*2*Math.PI + phase + jitter(i) - Math.PI/2;
      const [x,y] = ellipseXY(rx, ry, a);
      const el = document.querySelector(`.node[data-id="${m.id}"]`) || mkNode(m);
      el.classList.add(klass);
      place(el, x, y);
      if(!el.parentNode) stage.appendChild(el);
    });
  }

  function redraw(){
    const ALL = DATA.filter(m => SHOW.includes(m.id));
    const ring1 = ALL.filter(d => (d.ring||1)===1);
    const ring2 = ALL.filter(d => (d.ring||2)===2);
    distribute(ring1, Rx1, Ry1, 'r1');
    distribute(ring2, Rx2, Ry2, 'r2');
  }

  // ---- animazione
  let raf;
  function tick(){
    if(rotating) phase += speed;
    redraw();
    raf = requestAnimationFrame(tick);
  }

  // ---- interazioni: drag rotate + wheel zoom
  const stage = document.getElementById('stage');
  let dragging=false, lastX=0;
  stage.addEventListener('pointerdown', e=>{ dragging=true; lastX=e.clientX; rotating=false; stage.setPointerCapture(e.pointerId); });
  stage.addEventListener('pointermove', e=>{ if(!dragging) return; const dx=e.clientX-lastX; lastX=e.clientX; phase += dx/300; redraw(); });
  stage.addEventListener('pointerup',   ()=>{ dragging=false; rotating=true; });

  stage.addEventListener('wheel', e=>{
    e.preventDefault();
    scale = Math.min(1.6, Math.max(0.8, scale + (e.deltaY<0? 0.05:-0.05)));
    layout();
  }, {passive:false});

  // ---- deep-link all'avvio (?id=mef) e ricerca
  const params = new URLSearchParams(location.search);
  const startId = params.get('id');
  if (startId) {
    const m0 = DATA.find(m => m.id===startId);
    if (m0) openFull(m0);
  }
  document.getElementById('q')?.addEventListener('input', e=>{
    const v = e.target.value.toLowerCase().trim();
    const hit = DATA.find(m => (m.nome||'').toLowerCase().includes(v) || m.id===v);
    if(v && hit) openFull(hit);
  });

  // ---- boot
  window.addEventListener('resize', layout, {passive:true});
  layout();
  cancelAnimationFrame(raf); tick();

  // ---- toggle controls
  document.getElementById('auto')?.addEventListener('change', e => {
    rotating = e.target.checked;
  });

  document.getElementById('lines')?.addEventListener('change', e => {
    document.getElementById('svg').style.opacity = e.target.checked ? '1' : '0';
  });
})();
</script>
</body>
</html>

