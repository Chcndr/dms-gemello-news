<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="build" content="MAP-FIX-V2">
<title>Mappa Ministeri ‚Äî sandbox</title>
<style>
:root{
  --node: clamp(176px, 12.5vw, 256px);
  --radius: 18px;
  --ink: #e7fbf5;
  --chip: rgba(15,32,36,.76);
  --stroke: rgba(255,255,255,.10);
}

*{margin:0;padding:0;box-sizing:border-box}
body{font:400 16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:#0a1a1e;overflow-x:hidden}
a{color:inherit;text-decoration:none}
.nav{position:sticky;top:0;z-index:1000;display:flex;gap:8px;align-items:center;padding:12px 16px;background:rgba(10,26,30,.88);backdrop-filter:blur(12px);border-bottom:1px solid var(--stroke)}
.btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--chip);box-shadow:0 6px 14px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06)}
.btn:hover{outline:1px solid rgba(255,255,255,.06)}
.title{margin-left:auto;margin-right:auto;font-weight:700;letter-spacing:.3px}
.wrap{max-width:1280px;margin:0 auto;padding:0 16px 48px}

#stageWrap{ height: 74vh; position:relative;border:1px solid var(--stroke);border-radius:16px;padding:12px;background:radial-gradient(60% 70% at 50% 12%, rgba(20,184,166,.08) 0%, transparent 60%); }
#stage{ position: relative; height:100%; min-height:520px; border-radius:12px; overflow:hidden}

/* TILE QUADRATI allineati come Home */
.node{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:var(--node); height:var(--node);
  padding:16px; border-radius:var(--radius);
  background: var(--chip);
  border:1px solid var(--stroke);
  box-shadow:0 6px 18px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.06) inset;
  display:flex; align-items:center; justify-content:center;
  text-align:center; color:var(--ink);
  user-select:none;
}
.node .label{
  font-weight:800; line-height:1.15; letter-spacing:.2px;
  font-size: clamp(13px,1.05vw,18px);
  display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;
  overflow:hidden; text-wrap:balance;
}
/* rimuoviamo la sottoscritta "Agenzia/Ministero" */
.node .tag{ display:none !important; }

/* NODO CENTRALE: logo con glow blu, niente quadro sopra */
.node.center{
  width: clamp(220px, 15vw, 300px);
  height: clamp(220px, 15vw, 300px);
  background: rgba(15,32,36,.84);
  border:1px solid rgba(30,144,255,.35);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.06) inset,
    0 0 40px rgba(30,144,255,.22),
    0 24px 60px rgba(0,0,0,.40);
}
.node.center .label,.node.center .tag{ display:none; }
.node.center::before{
  content:""; position:absolute; inset:18%;
  background:url('../img/ministero-center.png') center/contain no-repeat;
  z-index:1; filter:brightness(1.1) drop-shadow(0 0 18px rgba(30,144,255,.45));
  opacity:.96;
}
.node.center::after{
  content:""; position:absolute; inset:-26%; border-radius:40%;
  background:radial-gradient(60% 70% at 50% 40%, rgba(30,144,255,.22) 0%, transparent 65%);
  filter:blur(16px); pointer-events:none;
}

/* LINEE su canvas: visibilit√† */
#links{position:absolute; inset:0; pointer-events:none;}
:root[data-lines='off'] #links{ opacity:0; }

/* foglio/scheda fullscreen */
#modal{position:fixed; inset:0; background:rgba(3,10,12,.72); backdrop-filter:blur(6px);
  display:none; align-items:center; justify-content:center; z-index:9999;}
#card{width:min(1080px,92vw); max-height:88vh; overflow:auto;
  background:#0f2024ee; border:1px solid var(--stroke); border-radius:18px; padding:18px;}
#card .hero{width:100%; max-height:320px; object-fit:cover; border-radius:12px; margin-bottom:12px;}
#card h2{margin:6px 0 8px}
#card .grid{display:grid; grid-template-columns: 1.4fr 1fr; gap:16px;}
#card .docs{display:flex; flex-wrap:wrap; gap:8px;}
#close{position:sticky; top:0; float:right; margin:-6px -6px 6px 6px}
@media (max-width: 900px){ #card .grid{grid-template-columns:1fr} }

.panel{margin-top:16px; padding:16px; border:1px solid var(--stroke); border-radius:12px; background:rgba(15,32,36,.42)}
.panel h3{margin:0 0 8px}
.meta{color:#8fa3a8; font-size:14px; margin:2px 0 12px}
.chips{display:flex; flex-wrap:wrap; gap:8px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--chip)}
.chip .k{opacity:.65}
.docs{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.doc{display:inline-flex;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip)}
.doc small{opacity:.7;margin-left:6px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto}
.switch{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px dashed var(--stroke);border-radius:999px;opacity:.9}
.legend{margin-top:8px; font-size:13px; color:#8fa3a8}
@media (max-width:720px){
  .node{width:calc(var(--node) * 0.8); height:calc(var(--node) * 0.8)}
  #stage{height:64vh; min-height:480px}
}

/* PATCH v2.3.1: frame + world + contrasto + logo simmetrico */
.frame{
  position:relative;
  height:min(78vh, calc(100dvh - 96px));
  min-height:560px;
  margin:12px 20px 20px;
  border:1px solid rgba(255,255,255,.22); /* pi√π chiaro */
  border-radius:16px;
  background:
    radial-gradient(60% 70% at 50% 14%, rgba(56,189,248,.10) 0%, transparent 62%),
    radial-gradient(40% 50% at 50% 80%, rgba(56,189,248,.06) 0%, transparent 60%);
}
#stage{ position:absolute; inset:0; overflow:hidden; touch-action:none; }
#world{
  position:absolute; left:50%; top:50%;
  transform: translate(-50%,-50%) scale(1);   /* resta il baseline */
  transform-origin:50% 50%;
  will-change: transform;
}

/* Logo palazzo (simmetrico, glow) */
#hubIcon{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:160px; height:160px; pointer-events:none; filter:drop-shadow(0 0 22px rgba(56,189,248,.45)); }
#hubIcon::before{
  content:""; position:absolute; inset:0;
  background:
    radial-gradient(60% 60% at 50% 50%, rgba(56,189,248,.22), transparent 60%),
    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="%23e6f7ff" stroke="%2300b3ff" stroke-width="12" stroke-linejoin="round" stroke-linecap="round"><path d="M32 200 L256 80 L480 200 Z"/><rect x="72" y="220" width="64" height="200"/><rect x="168" y="220" width="64" height="200"/><rect x="264" y="220" width="64" height="200"/><rect x="360" y="220" width="64" height="200"/><rect x="48" y="420" width="416" height="24"/></svg>') center/72% no-repeat;
  opacity:.96;
}
.node{width:200px;height:140px;padding:16px;border-radius:18px;background:rgba(15,32,36,.76);border:1px solid rgba(255,255,255,.10);box-shadow:0 6px 18px rgba(0,0,0,.25),0 0 0 1px rgba(255,255,255,.06) inset;display:flex;align-items:center;justify-content:center;text-align:center;}
.node .tag{display:none!important;}
.node .label{font-weight:800;line-height:1.16;letter-spacing:.2px;font-size:clamp(15px,1.25vw,20px);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-wrap:balance;}
:root[data-lines='off'] #links{opacity:0;transition:.3s}
:root[data-lines='on']  #links{opacity:1;transition:.3s}
</style>
</head>
<body>
  <div class="nav">
    <a class="btn" href="/dms-gemello-news/landing/home.html" target="_top">‚Üê Home</a>
    <a class="btn" href="/dms-gemello-news/" target="_top">üìö Spot</a>
    <div class="controls">
      <label class="switch"><input id="btn-auto" type="checkbox" checked> Auto-rotate</label>
      <label class="switch"><input id="btn-lines" type="checkbox" checked> Linee</label>
      <input id="q" placeholder="Cerca ministero‚Ä¶" style="margin-left:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip);color:var(--ink);">
    </div>
    <div class="title">Mappa Ministeri (sandbox)</div>
  </div>

  <div class="wrap">
    <main id="map">
      <div id="viewport" class="frame">
        <div id="stage" aria-label="Mappa radiale interattiva">
          <canvas id="links"></canvas>
          <div id="world"></div>        <!-- i .node vengono creati/append QUI -->
          <div id="hubIcon" aria-hidden="true"></div> <!-- logo palazzo -->
        </div>
      </div>
    </main>

    <div id="sheet" class="panel" hidden>
      <h3 class="ttl"></h3>
      <p class="meta"></p>
      <div class="chips"></div>
      <h4 style="margin:16px 0 6px">Documenti</h4>
      <div class="docs"></div>
      <p class="legend">Suggerimento: i link "Apri su Spot" evidenziano la card nella libreria; "Apri PDF" apre direttamente il documento (eventuale pagina prefissata).</p>
    </div>
  </div>

  <!-- Fullscreen Sheet -->
  <div id="modal" aria-hidden="true">
    <div id="card">
      <button id="close" class="btn">‚úï Chiudi</button>
      <img class="hero" alt="" />
      <h2 class="ttl"></h2>
      <div class="grid">
        <div>
          <p class="meta"></p>
          <ul class="bullets"></ul>
        </div>
        <div>
          <h4>Documenti</h4>
          <div class="docs"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* HOTFIX v2.3: viewport/stage/world + zoom/pan + linee + ricerca + deeplink */
const JSON_URL = '/dms-gemello-news/landing/data/ministeri.json?v=6';
let DATA = [];
let cx=0, cy=0, Rx1=0, Ry1=0, Rx2=0, Ry2=0;
let phase=0, speed=0.0016, rotating=true;
const SHOW = ['pcm','mef','interno','mimit','mase','mit','salute','maeci','agid','pagopa','ae','adm'];

// selettori viewport/stage/world
const viewport=document.getElementById('viewport');
const stage=document.getElementById('stage');
const world=document.getElementById('world');
const links=document.getElementById('links');

// trasformazioni globali
let scale=1, panX=0, panY=0, lastDist=null;
function apply(){
  // mantieni SEMPRE il baseline di centratura
  world.style.transform = `translate(-50%,-50%) translate(${panX}px,${panY}px) scale(${scale})`;
}

// layout: centro calcolato sempre sullo stage
function layout(){
  const rect = stage.getBoundingClientRect();
  cx = rect.width/2;   // variabili gi√† esistenti nel file
  cy = rect.height/2;
  links.width  = rect.width;
  links.height = rect.height;
  redraw();           // riposiziona i nodi rispetto a cx,cy
}

/* utilit√† */
function place(el,x,y){ el.style.left=x+'px'; el.style.top=y+'px'; el.style.transform='translate(-50%,-50%)'; }
function ellipseXY(rx,ry,a){ return [cx + rx*Math.cos(a), cy + ry*Math.sin(a)]; }
function jitter(i){ return (i%2 ? +0.06 : -0.06); }

/* layout */
function layout(){
  const rect = stage.getBoundingClientRect();
  cx = rect.width/2; cy = rect.height/2;
  const S = Math.min(rect.width, rect.height);
  Rx1 = Math.max(60, S*0.36);
  Ry1 = Math.max(40, rect.height*0.28);
  Rx2 = Math.max(80, S*0.46);
  Ry2 = Math.max(50, rect.height*0.36);
  links.width = rect.width; links.height = rect.height;
  redraw();
}

/* i tile DEVONO nascere in #world */
function mkNode(m){const el=document.createElement('div');el.className='node';el.dataset.id=m.id;el.innerHTML=`<div class="label">${m.nome}</div>`;el.onclick=()=>openFull(m);return el;}

function distribute(items, rx, ry, klass){
  const n = items.length || 1;
  items.forEach((m,i)=>{
    const a = (i/n)*2*Math.PI + phase + jitter(i) - Math.PI/2;
    const [x,y] = ellipseXY(rx, ry, a);
    let el = document.querySelector(`.node[data-id="${m.id}"]`);
    if(!el){ el = mkNode(m); world.appendChild(el); }
    el.classList.add(klass);
    place(el, x, y);
  });
}

/* disegno linee */
function drawLines(all){
  const ctx = links.getContext('2d');
  ctx.clearRect(0,0,links.width,links.height);
  if(document.documentElement.dataset.lines === 'off') return;
  ctx.strokeStyle = 'rgba(134,239,172,.22)';
  ctx.lineWidth = 1.2;
  all.forEach(m=>{
    const el = document.querySelector(`.node[data-id="${m.id}"]`);
    if(!el) return;
    const x = parseFloat(el.style.left), y = parseFloat(el.style.top);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
  });
}

function redraw(){
  if(!DATA.length) return;
  const ALL = DATA.filter(m => SHOW.includes(m.id));
  const r1 = ALL.filter(d => (d.ring||1)==1);
  const r2 = ALL.filter(d => (d.ring||2)==2);
  distribute(r1, Rx1, Ry1, 'r1');
  distribute(r2, Rx2, Ry2, 'r2');
  drawLines(ALL);
}

/* animazione */
let raf;
function tick(){ if(rotating) phase += speed; redraw(); raf = requestAnimationFrame(tick); }

// toggle linee
document.documentElement.dataset.lines='on';
document.getElementById('btn-lines')?.addEventListener('change',e=>{document.documentElement.dataset.lines=e.target.checked?'on':'off';redraw();});

// ricerca soft
const q=document.getElementById('q');
q?.addEventListener('input',()=>{const v=q.value.trim().toLowerCase();document.querySelectorAll('.node').forEach(n=>{if(n.classList.contains('center'))return;const hit=n.querySelector('.label').textContent.toLowerCase().includes(v);n.style.opacity=v?(hit?1:.18):1;n.style.filter=v&&hit?'drop-shadow(0 0 16px rgba(30,144,255,.35))':'';});});
q?.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=q.value.trim().toLowerCase();const hit=[...document.querySelectorAll('.node')].find(n=>!n.classList.contains('center')&&n.querySelector('.label').textContent.toLowerCase().includes(v));if(hit){const m=DATA.find(x=>x.id===hit.dataset.id);if(m)openFull(m);}}});

// deep-link
document.addEventListener('DOMContentLoaded',()=>{const id=new URLSearchParams(location.search).get('id');if(id){const m=DATA.find(x=>x.id===id);if(m)setTimeout(()=>openFull(m),0);}});

/* bootstrap */
async function bootstrap(){
  try{ const r = await fetch(JSON_URL,{cache:'no-store'}); DATA = await r.json(); }catch(e){ DATA=[]; }
  layout(); cancelAnimationFrame(raf); tick();
}
document.addEventListener('DOMContentLoaded', bootstrap);

// wheel/pinch invariati. Cambia il listener di resize:
window.addEventListener('resize', layout);

// toggle Auto-rotate
document.getElementById('btn-auto')?.addEventListener('change', e => {
  rotating = e.target.checked;
});

// --- Scheda fullscreen ---
const modal = document.getElementById('modal');
const imgHero = modal.querySelector('.hero');
const ttl = modal.querySelector('.ttl');
const meta = modal.querySelector('.meta');
const bullets = modal.querySelector('.bullets');
const docsBox = modal.querySelector('.docs');
document.getElementById('close').onclick = ()=> modal.style.display='none';

function openFull(m){
  modal.style.display = 'flex';
  ttl.textContent = m.nome || '';

  // breve linea descrittiva
  meta.textContent = [
    m.problema && `Problema: ${m.problema}`,
    m.soluzione && `Soluzione: ${m.soluzione}`,
    m.risultati && `Risultati: ${m.risultati}`
  ].filter(Boolean).join(' ‚Ä¢ ');

  // punti elenco (narrativa/valore)
  bullets.innerHTML = '';
  (m.punti||[]).forEach(t => {
    const li = document.createElement('li'); li.textContent = t; bullets.appendChild(li);
  });

  // hero illustrata (se manca, nascondi)
  if(m.hero){ imgHero.src = m.hero; imgHero.alt = m.alt || ''; imgHero.style.display='block'; }
  else { imgHero.style.display='none'; }

  // documenti (Spot o PDF diretto con #page)
  docsBox.innerHTML='';
  (m.docs||[]).forEach(d=>{
    const a = document.createElement('a'); a.className='doc'; a.target='_top';
    const spot = `/dms-gemello-news/#doc-${d.slug}`;
    const pdf  = `/dms-gemello-news/docs/${d.slug}.pdf${d.page?`#page=${d.page}`:''}`;
    a.href = d.open==='pdf' ? pdf : spot;
    a.textContent = d.label || (d.open==='pdf' ? 'Apri PDF' : 'Apri su Spot');
    if(d.page && d.open!=='pdf'){ const s=document.createElement('small'); s.textContent=` ¬∑ pag ${d.page}`; a.appendChild(s); }
    docsBox.appendChild(a);
  });
}
</script>
</body>
</html>

