<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DMS · Gemello Digitale — Mappa Ministeri</title>
  <style>
    /* Reset e base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* Pagina fissa per zoom funzionante */
    html, body {
      height: 100vh;
      overflow: hidden;
      background: #0a1a20;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #eaf1f5;
    }
    
    /* Navbar */
    .topnav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 2000;
      display: flex;
      gap: 0;
      background: rgba(11, 31, 38, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .topnav a {
      display: block;
      padding: 12px 20px;
      color: #b8d4e0;
      text-decoration: none;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
    }
    
    .topnav a:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #d7eef9;
    }
    
    .topnav a.active {
      background: rgba(15, 122, 76, 0.2);
      color: #6ee3ff;
      border-bottom-color: #0f7a4c;
    }
    
    /* Container principale */
    .main-container {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    /* Pannello comandi */
    .controls-panel {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      padding: 12px 24px;
      background: rgba(22, 42, 51, 0.8);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-group label {
      font-size: 14px;
      font-weight: 500;
      color: #b8d4e0;
    }
    
    .control-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #0f7a4c;
    }
    
    .search-input {
      padding: 8px 12px;
      background: rgba(11, 31, 38, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 8px;
      color: #eaf1f5;
      font-size: 14px;
      width: 200px;
    }
    
    .search-input::placeholder {
      color: #7a9aa8;
    }
    
    .page-title {
      font-size: 16px;
      font-weight: 600;
      color: #d7eef9;
    }
    
    /* Container mappa fisso */
    #mapContainer {
      position: relative;
      width: min(1280px, 96vw);
      height: min(800px, 80vh);
      background: #0b1f26;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.06),
        0 30px 120px rgba(0, 0, 0, 0.55),
        inset 0 0 120px rgba(0, 206, 255, 0.03);
      transform-origin: center center;
      transition: transform 0.3s ease;
    }
    
    /* Zoom levels */
    #mapContainer.zoom-80 { transform: scale(0.8); }
    #mapContainer.zoom-100 { transform: scale(1.0); }
    #mapContainer.zoom-120 { transform: scale(1.2); }
    
    /* Linee radiali */
    .spoke {
      position: absolute;
      inset: 0;
      z-index: 5;
      transform-origin: center center;
      transition: transform 0.1s linear;
    }
    
    /* Linee radiali */
    #spokes {
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
    }
    
    .spoke {
      position: absolute;
      left: 50%;
      top: 50%;
      height: 2px;
      width: calc(var(--spoke-length, 200px) - 80px);
      transform-origin: 0 0;
      opacity: 0.8;
      background: linear-gradient(to right, rgba(0, 206, 255, 0.6), rgba(0, 206, 255, 0.2) 70%, transparent);
      box-shadow: 0 0 4px rgba(0, 206, 255, 0.4);
      transition: opacity 0.3s ease, width 0.3s ease;
    }
    
    #spokes.hidden .spoke {
      opacity: 0;
    }
    
    /* Nodi ministeri */
    .node {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 160px;
      height: 90px;
      transform: translate(-50%, -50%) rotate(var(--counter-rotate, 0deg));
      background: rgba(22, 42, 51, 0.95);
      color: #d7eef9;
      border: none;
      border-radius: 16px;
      font-weight: 600;
      font-size: 13px;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.08),
        0 10px 35px rgba(0, 206, 255, 0.10),
        inset 0 0 28px rgba(0, 206, 255, 0.25);
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      z-index: 20;
    }
    
    .node:hover, .node:focus {
      background: #1a3240;
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.12),
        0 15px 45px rgba(0, 206, 255, 0.20),
        inset 0 0 35px rgba(0, 206, 255, 0.35);
      transform: translate(-50%, -50%) rotate(var(--counter-rotate, 0deg)) scale(1.02);
    }
    
    .node:active {
      transform: translate(-50%, -50%) rotate(var(--counter-rotate, 0deg)) scale(0.98);
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.15),
        0 20px 55px rgba(0, 206, 255, 0.30),
        inset 0 0 42px rgba(0, 206, 255, 0.45);
    }
    
    .node:focus {
      outline: 2px solid rgba(110, 227, 255, 0.6);
      outline-offset: 2px;
    }
    
    .node.filtered {
      opacity: 0.3;
      pointer-events: none;
    }
    
    /* Modal */
    #modal {
      position: fixed;
      inset: 0;
      z-index: 3000;
      display: none;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }
    
    #modal.is-open {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-card {
      width: min(92vw, 1140px);
      max-height: 90vh;
      background: #0b161b;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 30px 120px rgba(0, 0, 0, 0.7);
      transform: scale(1);
      transition: transform 0.2s ease;
    }
    
    #modal:not(.is-open) .modal-card {
      transform: scale(0.95);
    }
    
    .modal-header {
      background: #0f7a4c;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
    }
    
    .modal-back {
      background: #0b5f3a;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
    }
    
    .modal-back:hover {
      background: #0a5232;
    }
    
    .modal-title {
      flex: 1;
      font-size: 18px;
      font-weight: 700;
      margin: 0;
    }
    
    .modal-spot {
      background: #0e2230;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
    }
    
    .modal-spot:hover {
      background: #1a3240;
    }
    
    .modal-body {
      padding: 20px;
      max-height: calc(90vh - 80px);
      overflow-y: auto;
    }
    
    .doc-card {
      margin: 0 0 16px 0;
    }
    
    .doc-card img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    /* Zoom controls */
    .zoom-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }
    
    .zoom-btn {
      width: 36px;
      height: 36px;
      background: rgba(22, 42, 51, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 8px;
      color: #b8d4e0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .zoom-btn:hover {
      background: rgba(22, 42, 51, 1);
      color: #d7eef9;
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .zoom-btn.active {
      background: #0f7a4c;
      color: #fff;
      border-color: #0f7a4c;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .controls-panel {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }
      
      .search-input {
        width: 100%;
      }
      
      .node {
        width: 120px;
        height: 70px;
        font-size: 11px;
      }
      
      #centerLogo {
        width: 70px;
        height: 70px;
      }
    }

    /* Anelli concentrici */
    #ring-inner, #ring-outer {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      transform-origin: center center;
    }

    /* Rotazioni indipendenti */
    #ring-inner {
      animation: rotateInner 40s linear infinite;
    }

    #ring-outer {
      animation: rotateOuter 60s linear infinite;
    }

    /* Pausa rotazioni quando auto-rotate è disattivato */
    body:not(.auto-rotate) #ring-inner,
    body:not(.auto-rotate) #ring-outer {
      animation-play-state: paused;
    }

    /* Keyframes per rotazioni */
    @keyframes rotateInner {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    @keyframes rotateOuter {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Nodi: contro-rotazione per rimanere orizzontali */
    #ring-inner .node {
      animation: counterRotateInner 40s linear infinite;
    }

    #ring-outer .node {
      animation: counterRotateOuter 60s linear infinite;
    }

    /* Pausa contro-rotazioni quando auto-rotate è disattivato */
    body:not(.auto-rotate) #ring-inner .node,
    body:not(.auto-rotate) #ring-outer .node {
      animation-play-state: paused;
    }

    /* Keyframes per contro-rotazioni */
    @keyframes counterRotateInner {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(-360deg); }
    }

    @keyframes counterRotateOuter {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(-360deg); }
    }

    /* Raggi: girano con la corona */
    #spokes {
      animation: rotateSpokes 50s linear infinite;
    }

    body:not(.auto-rotate) #spokes {
      animation-play-state: paused;
    }

    @keyframes rotateSpokes {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Centro fisso: logo ministero (no riquadro, glow blu) */
    #hubIcon{
      position:absolute;
      left:50%; top:50%;
      width:clamp(160px, 13vw, 240px);
      height:clamp(160px, 13vw, 240px);
      transform:translate(-50%, -50%);
      pointer-events:none;
      z-index: 5;
      filter:
        drop-shadow(0 0 32px rgba(56,189,248,.35))
        drop-shadow(0 8px 22px rgba(0,0,0,.45));
      opacity:.98;
    }

    /* Applica il logo come background (SVG inline in data-URL) */
    #hubIcon::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(60% 60% at 50% 50%, rgba(56,189,248,.18), transparent 60%),
        url("data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 640' aria-hidden='true'><defs><linearGradient id='g' x1='0' x2='0' y1='0' y2='1'><stop offset='0' stop-color='%23e6f7ff'/><stop offset='1' stop-color='%23c9eeff'/></linearGradient></defs><g fill='url(%23g)' stroke='%2300b3ff' stroke-width='18' stroke-linejoin='round'><path d='M20 246h600L320 92 20 246z'/><rect x='120' y='276' width='80' height='240' rx='6'/><rect x='240' y='276' width='80' height='240' rx='6'/><rect x='320' y='276' width='80' height='240' rx='6'/><rect x='440' y='276' width='80' height='240' rx='6'/><rect x='48'  y='532' width='544' height='30' rx='6'/></g></svg>") center/72% no-repeat;
    }

    /* Assicurati che NON ruoti mai col resto */
    #hubIcon { will-change: filter, opacity; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="topnav">
    <a href="/dms-gemello-news/landing/home.html">Home</a>
    <a href="/dms-gemello-news/landing/mappa-ministeri.html" class="active">Mappa</a>
    <a href="/dms-gemello-news/landing/spot.html">Spot</a>
  </nav>

  <!-- Container principale -->
  <div class="main-container">
    <!-- Pannello comandi -->
    <div class="controls-panel">
      <div class="control-group">
        <input type="checkbox" id="autoRotate" checked>
        <label for="autoRotate">Auto-rotate</label>
      </div>
      
      <div class="control-group">
        <input type="checkbox" id="showLines" checked>
        <label for="showLines">Linee</label>
      </div>
      
      <input type="text" class="search-input" id="searchInput" placeholder="Cerca ministero...">
      
      <div class="page-title">Mappa Ministeri (sandbox)</div>
    </div>

    <!-- Container mappa -->
    <div id="mapContainer" class="zoom-100">
      <!-- Logo centrale fisso -->
      <div id="hubIcon" aria-hidden="true"></div>

      <!-- Linee radiali -->
      <div id="spokes"></div>

      <!-- Anello interno (8 nodi) -->
      <div id="ring-inner">
        <button class="node" data-slug="agid" aria-label="AgID">
          AgID
        </button>
        <button class="node" data-slug="mef" aria-label="MEF - Economia e Finanze">
          MEF · Economia<br>e Finanze
        </button>
        <button class="node" data-slug="interno" aria-label="Ministero dell'Interno">
          Ministero<br>dell'Interno
        </button>
        <button class="node" data-slug="salute" aria-label="Ministero della Salute">
          Ministero<br>della Salute
        </button>
        <button class="node" data-slug="turismo" aria-label="Ministero del Turismo">
          Ministero<br>del Turismo
        </button>
        <button class="node" data-slug="lavoro" aria-label="Ministero del Lavoro">
          Ministero<br>del Lavoro
        </button>
        <button class="node" data-slug="mit" aria-label="MIT - Infrastrutture e Trasporti">
          MIT · Infrastrutture<br>e Trasporti
        </button>
        <button class="node" data-slug="mim" aria-label="MIM - Istruzione e Merito">
          MIM · Istruzione<br>e Merito
        </button>
      </div>

      <!-- Anello esterno (8 nodi) -->
      <div id="ring-outer">
        <button class="node" data-slug="mimit" aria-label="MIMIT - Imprese e Made in Italy">
          MIMIT · Imprese<br>e Made in Italy
        </button>
        <button class="node" data-slug="mase" aria-label="MASE - Ambiente e Sicurezza">
          MASE · Ambiente<br>e Sicurezza
        </button>
        <button class="node" data-slug="masaf" aria-label="MASAF - Agricoltura">
          MASAF ·<br>Agricoltura
        </button>
        <button class="node" data-slug="maeci" aria-label="MAECI - Affari Esteri">
          MAECI ·<br>Affari Esteri
        </button>
        <button class="node" data-slug="mic" aria-label="MIC - Cultura">
          MIC ·<br>Cultura
        </button>
        <button class="node" data-slug="ae" aria-label="AE - Agenzia Entrate">
          AE · Agenzia<br>Entrate
        </button>
        <button class="node" data-slug="adm" aria-label="ADM - Agenzia Dogane">
          ADM · Agenzia<br>Dogane
        </button>
        <button class="node" data-slug="pagopa" aria-label="PagoPA S.p.A.">
          PagoPA S.p.A.
        </button>
      </div>

      <!-- Controlli zoom -->
      <div class="zoom-controls">
        <button class="zoom-btn" data-zoom="80">0.8×</button>
        <button class="zoom-btn active" data-zoom="100">1.0×</button>
        <button class="zoom-btn" data-zoom="120">1.2×</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <header class="modal-header">
        <button class="modal-back" id="modalBack" aria-label="Torna alla mappa">← Torna alla mappa</button>
        <h2 class="modal-title" id="modalTitle"></h2>
        <a class="modal-spot" id="modalSpot" href="#" target="_blank">Apri in SPOT</a>
      </header>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // Dati ministeri inline
    const MINISTERI_DATA = {
      agid: { 
        title: "AgID", 
        cards: [{ img: "/dms-gemello-news/assets/doc/agid.jpg", alt: "AgID" }] 
      },
      mef: { 
        title: "MEF - Economia e Finanze", 
        cards: [{ img: "/dms-gemello-news/assets/doc/mef.jpg", alt: "MEF" }] 
      },
      interno: { 
        title: "Ministero dell'Interno", 
        cards: [{ img: "/dms-gemello-news/assets/doc/interno.jpg", alt: "Interno" }] 
      },
      salute: { 
        title: "Ministero della Salute", 
        cards: [{ img: "/dms-gemello-news/assets/doc/salute.jpg", alt: "Salute" }] 
      },
      turismo: { 
        title: "Ministero del Turismo", 
        cards: [{ img: "/dms-gemello-news/assets/doc/turismo.jpg", alt: "Turismo" }] 
      },
      lavoro: { 
        title: "Ministero del Lavoro", 
        cards: [{ img: "/dms-gemello-news/assets/doc/lavoro.jpg", alt: "Lavoro" }] 
      },
      mit: { 
        title: "MIT - Infrastrutture e Trasporti", 
        cards: [{ img: "/dms-gemello-news/assets/doc/mit.jpg", alt: "MIT" }] 
      },
      mim: { 
        title: "MIM - Istruzione e Merito", 
        cards: [{ img: "/dms-gemello-news/assets/doc/mim.jpg", alt: "MIM" }] 
      },
      mimit: { 
        title: "MIMIT - Imprese e Made in Italy", 
        cards: [{ img: "/dms-gemello-news/assets/doc/mimit.jpg", alt: "MIMIT" }] 
      },
      mase: { 
        title: "MASE - Ambiente e Sicurezza", 
        cards: [{ img: "/dms-gemello-news/assets/doc/mase.jpg", alt: "MASE" }] 
      },
      masaf: { 
        title: "MASAF - Agricoltura", 
        cards: [{ img: "/dms-gemello-news/assets/doc/masaf.jpg", alt: "MASAF" }] 
      },
      maeci: { 
        title: "MAECI - Affari Esteri", 
        cards: [{ img: "/dms-gemello-news/assets/doc/maeci.jpg", alt: "MAECI" }] 
      },
      mic: { 
        title: "MIC - Cultura", 
        cards: [{ img: "/dms-gemello-news/assets/doc/mic.jpg", alt: "MIC" }] 
      },
      ae: { 
        title: "AE - Agenzia Entrate", 
        cards: [{ img: "/dms-gemello-news/assets/doc/ae.jpg", alt: "AE" }] 
      },
      adm: { 
        title: "ADM - Agenzia Dogane", 
        cards: [{ img: "/dms-gemello-news/assets/doc/adm.jpg", alt: "ADM" }] 
      },
      pagopa: { 
        title: "PagoPA S.p.A.", 
        cards: [{ img: "/dms-gemello-news/assets/doc/pagopa.jpg", alt: "PagoPA" }] 
      }
    };

    // Elementi DOM
    const ringInner = document.getElementById('ring-inner');
    const ringOuter = document.getElementById('ring-outer');
    const spokes = document.getElementById('spokes');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalBack = document.getElementById('modalBack');
    const modalSpot = document.getElementById('modalSpot');
    const autoRotateCheck = document.getElementById('autoRotate');
    const showLinesCheck = document.getElementById('showLines');
    const searchInput = document.getElementById('searchInput');
    const mapContainer = document.getElementById('mapContainer');
    const nodesInner = document.querySelectorAll('#ring-inner .node');
    const nodesOuter = document.querySelectorAll('#ring-outer .node');
    const allNodes = document.querySelectorAll('.node');

    // Variabili globali
    let rotationAngle = 0;
    let rotationInterval = null;
    let currentZoom = 100;

    // iPad: disabilita preview e long-press
    document.addEventListener('contextmenu', e => e.preventDefault(), { passive: false });
    document.addEventListener('selectstart', e => e.preventDefault(), { passive: false });

    // Inizializzazione
    function init() {
      setupNodes();
      setupSpokes();
      setupEventListeners();
      handleInitialHash();
      startAutoRotation();
    }

    // Setup posizionamento nodi concentrici
    function setupNodes() {
      const innerRadius = Math.min(160, Math.min(mapContainer.offsetWidth, mapContainer.offsetHeight) * 0.20);
      const outerRadius = Math.min(240, Math.min(mapContainer.offsetWidth, mapContainer.offsetHeight) * 0.30);
      
      // Aggiorna variabile CSS per lunghezza linee (usa il raggio esterno)
      document.documentElement.style.setProperty('--spoke-length', `${outerRadius}px`);
      
      // Posiziona nodi anello interno (8 nodi)
      nodesInner.forEach((node, index) => {
        const angle = (360 / 8) * index + 22.5; // Sfalsamento di 22.5°
        const radian = (angle * Math.PI) / 180;
        
        const x = Math.cos(radian) * innerRadius;
        const y = Math.sin(radian) * innerRadius;
        
        node.style.left = `calc(50% + ${x}px)`;
        node.style.top = `calc(50% + ${y}px)`;
        node.dataset.angle = angle;
        
        // Contro-rotazione per mantenere testo orizzontale
        node.style.setProperty('--counter-rotate', `-${angle}deg`);
      });
      
      // Posiziona nodi anello esterno (8 nodi)
      nodesOuter.forEach((node, index) => {
        const angle = (360 / 8) * index; // Nessuno sfalsamento iniziale
        const radian = (angle * Math.PI) / 180;
        
        const x = Math.cos(radian) * outerRadius;
        const y = Math.sin(radian) * outerRadius;
        
        node.style.left = `calc(50% + ${x}px)`;
        node.style.top = `calc(50% + ${y}px)`;
        node.dataset.angle = angle;
        
        // Contro-rotazione per mantenere testo orizzontale
        node.style.setProperty('--counter-rotate', `-${angle}deg`);
      });
    }

    // Setup linee radiali
    function setupSpokes() {
      spokes.innerHTML = '';
      
      // Linee per anello interno (8 linee)
      for (let i = 0; i < 8; i++) {
        const spoke = document.createElement('div');
        spoke.className = 'spoke';
        spoke.style.transform = `rotate(${(360 / 8) * i + 22.5}deg)`;
        spokes.appendChild(spoke);
      }
      
      // Linee per anello esterno (8 linee)
      for (let i = 0; i < 8; i++) {
        const spoke = document.createElement('div');
        spoke.className = 'spoke';
        spoke.style.transform = `rotate(${(360 / 8) * i}deg)`;
        spokes.appendChild(spoke);
      }
    }

    // Event listeners
    function setupEventListeners() {
      // Click nodi
      allNodes.forEach(node => {
        node.addEventListener('click', () => {
          const slug = node.dataset.slug;
          openModal(slug);
        });
      });

      // Modal
      modalBack.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // Keyboard
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });

      // Auto-rotate
      autoRotateCheck.addEventListener('change', (e) => {
        if (e.target.checked) {
          startAutoRotation();
        } else {
          stopAutoRotation();
        }
      });

      // Linee
      showLinesCheck.addEventListener('change', (e) => {
        spokes.classList.toggle('hidden', !e.target.checked);
      });

      // Ricerca
      searchInput.addEventListener('input', handleSearch);

      // Zoom
      document.querySelectorAll('.zoom-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const zoom = parseInt(btn.dataset.zoom);
          setZoom(zoom);
        });
      });

      // Hash change
      window.addEventListener('hashchange', handleHashChange);
    }

    // Auto-rotation
    // Auto-rotation (ora gestita da CSS)
    function startAutoRotation() {
      document.body.classList.add('auto-rotate');
    }

    function stopAutoRotation() {
      document.body.classList.remove('auto-rotate');
    }

    // Modal
    function openModal(slug) {
      const data = MINISTERI_DATA[slug];
      if (!data) return;

      modalTitle.textContent = data.title;
      modalSpot.href = `/dms-gemello-news/landing/spot.html#${slug}`;
      
      // Render cards
      modalBody.innerHTML = data.cards.map(card => 
        `<div class="doc-card">
          <img src="${card.img}" alt="${card.alt}" loading="lazy">
        </div>`
      ).join('');

      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden', 'false');
      
      // Update hash
      if (location.hash.slice(1) !== slug) {
        history.pushState(null, '', `#${slug}`);
      }
    }

    function closeModal() {
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
      
      // Clear hash
      if (location.hash) {
        history.pushState(null, '', location.pathname);
      }
    }

    // Hash handling
    function handleInitialHash() {
      const slug = location.hash.slice(1);
      if (slug && MINISTERI_DATA[slug]) {
        openModal(slug);
      }
    }

    function handleHashChange() {
      const slug = location.hash.slice(1);
      if (slug && MINISTERI_DATA[slug]) {
        openModal(slug);
      } else {
        closeModal();
      }
    }

    // Ricerca
    function handleSearch() {
      const query = searchInput.value.toLowerCase().trim();
      
      allNodes.forEach(node => {
        const slug = node.dataset.slug;
        const data = MINISTERI_DATA[slug];
        const text = node.textContent.toLowerCase();
        
        const matches = !query || 
          text.includes(query) || 
          slug.includes(query) || 
          data.title.toLowerCase().includes(query);
        
        node.classList.toggle('filtered', !matches);
      });
    }

    // Zoom
    function setZoom(zoom) {
      currentZoom = zoom;
      mapContainer.className = `zoom-${zoom}`;
      
      // Ricalcola posizioni e linee per il nuovo zoom
      setupNodes();
      
      document.querySelectorAll('.zoom-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.zoom) === zoom);
      });
    }

    // Avvio
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

